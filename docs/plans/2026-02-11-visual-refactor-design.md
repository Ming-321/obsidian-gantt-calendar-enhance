# 视觉风格重构设计方案

> 日期：2026-02-11
> 状态：已实施（v2.1.0）
> 版本：v4（增补配色修正 + 周视图层级增强 + 任务视图优化 + 交互模型重构）

---

## 1. 统一配色语言

### 1.1 优先级三色（核心色彩语言）

颜色主要传达**优先级**维度，三个视图统一使用：

| 优先级 | 名称 | 亮色主题 | 暗色主题 | 语义 |
|--------|------|----------|----------|------|
| 高 | 赤陶橙 | `#d97757` | `#d97757` | 暖色 = 紧迫 |
| 普通 | 清澈蓝 | `#6BB3E0` | `#6BB3E0` | 清晰蓝 = 平稳 |
| 低 | 灰色 | `#8b949e` | `#9aafbf` | 灰暗 = 不重要 |

> v3→v4 变更：互换了普通和低优先级的颜色。旧方案中水蓝(#5b9fd0)比岩灰蓝(#7c8ea0)更鲜艳，导致低优先级视觉上比普通更突出。新方案形成 橙→蓝→灰 的鲜艳度递减梯度。
> 暗色主题下低优先级灰色调亮为 `#9aafbf` 以保证对比度；普通优先级 `#6BB3E0` 本身足够亮，暗色主题下不变。

### 1.2 特殊状态色

| 状态 | 名称 | 色值 |
|------|------|------|
| 已完成 | 翠绿 | `#3fb950` |
| 已取消 | 中性灰 | `#8b949e` |
| 过期 | 警示红 | `#e5534b` |
| 今天高亮 | 浅红底 | `rgba(255, 107, 107, 0.08)` |

### 1.3 类型区分（非颜色手段）

颜色已分配给优先级，任务类型通过以下方式区分：

| 类型 | 图标 | 字体 |
|------|------|------|
| 待办 | 状态图标（见 §3） | 正体 |
| 提醒 | 🔔 铃铛（SVG/Lucide） | *斜体* |

> 不使用虚线/实线区分类型。提醒仅通过图标和斜体区分。

### 1.4 层级区分（周视图甘特条专用）

| 层级 | 左色带 | 背景填充 | 标题装饰 | 文字缩进 |
|------|--------|----------|----------|----------|
| 父任务 | 3px 实线 | 优先级色 opacity 0.12 | 有子条目时下划线 | 0（顶格） |
| 子任务 | 2px 实线 | 透明 | 有孙任务时下划线 | padding-left 20px |
| 孙任务 | 2px 虚线 | 透明 | 无装饰 | padding-left 34px |

> v3→v4 变更（实施版本 v2.1.0）：
> - 原设计为加粗父任务标题，实施中改为下划线标识有子条目（可展开）
> - 去掉了折叠/展开三角箭头，改为左键单击展开/折叠、右键打开编辑菜单
> - 缩进通过 `padding-left` 实现文字缩进，bar 块保持日期对齐不变
> - 子/孙任务条尺寸缩小（min-height/font-size 降低）

### 1.5 已完成任务（三视图统一）

- 左色带颜色覆盖为绿色 `#3fb950`
- 整体透明度降至 0.5
- 标题加删除线

### 1.6 已取消任务（三视图统一）

- 左色带颜色覆盖为灰色 `#8b949e`
- 整体透明度降至 0.4
- 标题加删除线

### 1.7 已过期任务（未完成 + 截止日已过）

- 保留原优先级色带不变
- 倒计时文字变红 `#e5534b`（如"已过期2天"）
- 周视图甘特条右侧边缘加红色竖线标记

### 1.8 标签色

保持现有 6 色哈希系统，仅在任务视图中显示标签 pill。月视图不显示标签。

### 1.9 背景色

- 不自定义整体背景，继承 Obsidian 的 `--background-primary` / `--background-secondary`
- 任务条背景统一透明/极淡灰，只有左边色带传达优先级
- 确保三色在亮色和暗色主题下均有足够对比度

### 1.10 色带 vs 边框

**色带**和**边框**是两个独立的视觉元素：

- **色带**：位于卡片/甘特条内部左侧，使用 `::before` 伪元素实现，传达优先级/状态
  - 可变宽度（2/3px）
  - 可变样式（solid/dashed）
  - 可变颜色（优先级色 / 绿色完成 / 灰色取消）
- **边框**：卡片/甘特条的外边框（`border`），颜色随背景/主题变化，不传达优先级信息

### 1.11 已完成/已取消图标透明度例外

已完成（opacity 0.5）和已取消（opacity 0.4）任务的整体透明度降低，但**状态图标保持 opacity 1.0**，确保用户能清晰看到并点击图标来撤销完成/取消。

### 1.12 字体大小

| 视图 | 字体大小 |
|------|----------|
| 月视图任务标题 | 12px |
| 任务视图标题 | 13px |
| 周视图甘特条标签 | 12px |

### 1.13 今天高亮统一

所有视图中"今天"的高亮背景统一使用 `--gc-today-bg: rgba(255, 107, 107, 0.08)`，包括：
- 月视图日格背景
- 周视图 header 日期格
- 周视图 grid 列背景

---

## 2. 任务状态系统简化

### 2.1 从 7 种简化为 4 种

| 状态 | key | 名称 | 视觉表现 |
|------|-----|------|----------|
| 待办 | `todo` | 待办 | 正常显示（色带=优先级色）|
| 进行中 | `in_progress` | 进行中 | 正常显示，仅通过状态图标（◐ 半填充圆）区分 |
| 已完成 | `done` | 已完成 | 绿色色带 + 删除线 + opacity 0.5 |
| 已取消 | `canceled` | 已取消 | 灰色色带 + 删除线 + opacity 0.4 |

> `in_progress` 不再加粗色带（3px→4px 太微小），仅通过状态图标区分。

**完全移除的状态和功能**：
- `important` 状态 → 由 high priority 替代
- `question` 状态 → 移除（用标签代替）
- `start` 状态 → 合并到 `in_progress`
- 自定义状态功能 → 完全移除
- 状态颜色配置 → 完全移除（颜色由优先级决定）
- 马卡龙色卡 → 移除

### 2.2 状态切换

**待办类型**：
- 点击状态图标循环切换：待办 → 进行中 → 已完成 → 待办
- 取消通过右键菜单或编辑弹窗操作

**提醒类型**：
- 不可通过点击切换状态
- 到期自动完成并归档
- 状态变更只能通过编辑弹窗

### 2.3 父子任务状态联动（递归传播）

**父→子（向下传播，递归到所有后代）**：
- 父标记为「已完成」→ 所有未完成后代（子、孙、曾孙…）自动标记为「已完成」
- 父标记为「已取消」→ 所有后代标记为「已取消」
- 父从「已完成」退回「待办」→ 所有后代退回「待办」

**子→父（向上聚合，递归到所有祖先）**：
- 全部子任务完成 → 父任务自动标记为「已完成」→ 继续检查祖父
- 不再全部完成 → 父任务退回「进行中」
- 第一个子任务变为「进行中」或「已完成」→ 父任务自动变为「进行中」

**已取消任务保护**：
- 父任务已取消时，子任务状态图标不可点击
- 要修改子任务，必须先通过右键菜单/编辑弹窗恢复父任务

**防循环保护**：联动更新时标记"来源方向"（`propagationDirection: 'down' | 'up' | 'none'`），避免向下传播再触发向上聚合导致无限循环。

### 2.4 数据迁移

首次加载时检测旧数据并执行一次性迁移：

**任务数据迁移**：
- `status: "important"` → `status: "todo"`, `priority: "high"`
- `status: "start"` → `status: "in_progress"`
- `status: "question"` → `status: "todo"`
- `dueDate: null/undefined` → 设为一个月后（从迁移执行日起）
- 移除所有自定义状态相关数据

**预设数据迁移**（`ViewPreset.filters.statuses`）：
- `"important"` → 从预设状态列表中移除
- `"start"` → 替换为 `"in_progress"`
- `"question"` → 从预设状态列表中移除

### 2.5 默认筛选状态变更

- 旧默认：`selectedStatuses: ['todo']`
- 新默认：`selectedStatuses: ['todo', 'in_progress']`

> 简化为 4 状态后，用户通常同时需要看到"待办"和"进行中"任务。

---

## 3. 状态图标组件

### 3.1 替代方案

替代现有 `<input type="checkbox">`，使用 CSS 绘制的圆形图标：

| 状态 | 视觉 | CSS 实现 |
|------|------|----------|
| todo | 空心圆 ○ | 1.5px 边框圆（颜色=优先级色），无填充 |
| in_progress | 半填充圆 ◐ | 空心圆 + 左半填充（颜色=优先级色） |
| done | 实心勾 ✓ | 填充圆（绿色 `#3fb950`）+ 白色勾号（SVG path） |
| canceled | 实心叉 × | 填充圆（灰色 `#8b949e`）+ 白色叉号（SVG path） |

提醒类型：始终显示 🔔 铃铛图标（SVG/Lucide icon），不可点击切换。

> 使用 SVG path 绘制勾号和叉号确保在 14px 尺寸下清晰渲染。

### 3.2 尺寸

| 视图 | 图标尺寸 |
|------|----------|
| 月视图 | 14×14px |
| 周视图甘特条 | 14×14px |
| 任务视图 | 16×16px |

### 3.3 交互

- 待办类型：单击循环 todo → in_progress → done → todo
- 提醒类型：不可点击切换
- 已取消父任务的子任务：不可点击（灰化处理）
- 过渡动画：opacity fade，50ms

### 3.4 组件接口

```typescript
// src/components/StatusIcon.ts
class StatusIcon {
  private status: TaskStatusType;
  private priority: TaskPriority;
  private isReminder: boolean;
  private disabled: boolean;  // 父任务取消时禁用
  
  render(container: HTMLElement): HTMLElement;
  updateStatus(newStatus: TaskStatusType): void;
  setDisabled(disabled: boolean): void;
  onClick(callback: (newStatus: TaskStatusType) => void): void;
}
```

---

## 4. 月视图

### 目标
中长期规划概览，极致紧凑。

### 任务条结构
```
▍○ 完成项目报告              ← 赤陶橙色带=高优先级，○=待办
▍○ 准备会议材料              ← 岩灰蓝色带=普通优先级
▍🔔 牙医预约                 ← 水蓝色带=低优先级，斜体=提醒
▍✓ ̶已̶完̶成̶任̶务̶              ← 绿色带 + 勾号 + 删除线 + 半透明
▍○ 期末项目 [2/5]            ← 进度为独立元素，不会被标题截断吞掉
```

### 显示内容
- ✅ 左色带 3px（`::before` 伪元素，优先级色，已完成/已取消时覆盖）
- ✅ 状态图标（14px，CSS 圆形），提醒=🔔
- ✅ 标题文字（提醒用斜体，flex-grow，text-overflow: ellipsis）
- ✅ 过期任务标题文字变红 `#e5534b`（已过截止日且未完成）
- ✅ 父任务进度 [n/m]（独立元素，flex-shrink: 0，始终可见）
- ❌ 不显示：标签、日期文字、优先级文字、详情

### 布局结构
```html
<div class="gc-month-task" style="display: flex; align-items: center;">
  <!-- ::before 色带 3px -->
  <span class="status-icon"><!-- 14px --></span>
  <span class="title" style="flex: 1; overflow: hidden; text-overflow: ellipsis;">标题</span>
  <span class="progress" style="flex-shrink: 0;">[2/5]</span>
</div>
```

### 交互
- 点击状态图标：循环切换状态（待办类型）
- 点击标题区域：打开编辑弹窗
- hover：tooltip 显示完整信息（标题、类型、优先级、状态、标签、日期、详情）
- 拖拽：改日期（保留）
- 右键：上下文菜单（保留）

### 网格布局
- 7 列 × 最多 6 行，保持不变
- 日格内任务超出可滚动
- 今天格子用 `rgba(255, 107, 107, 0.08)` 浅红底
- 农历日期保留

### 间距优化
- 任务条高度：20-22px
- 任务条间隙：1-2px
- 日格内边距：top 2px, sides 3px, bottom 2px

---

## 5. 任务视图

### 目标
最完整的信息展示。合并简洁/完整双模式为单一模式。

### 约束
- 所有任务必须设置截止日期

### 卡片布局（响应式单行/双行，左对齐 + 透明背景）

> v3→v4 变更：卡片背景从白色改为透明；内容从居中改为左对齐；标签在空间充足时与标题同行，空间不足时自动折到第二行。

```
空间充足时（一行）：
▍○ 完成项目报告  #工作 #重要              3天后 · 2/14

空间不足时（两行，标签折到第二行）：
▍○ 完成项目报告                           3天后 · 2/14
▍  #工作 #重要

无标签时（始终一行）：
▍○ 买文具                                 后天 · 2/13
```

布局结构：
```html
<div class="gc-task-card gc-task-card--task">
  <!-- ::before 色带 3px -->
  <!-- 主行（flex-wrap: wrap，允许标签折行） -->
  <div class="gc-task-card__main" style="display: flex; flex-wrap: wrap; align-items: center; gap: 6px;">
    <span class="gc-status-icon"><!-- 16px --></span>
    <span class="gc-task-card__text" style="flex: 1; min-width: 0;">标题</span>
    <span class="gc-task-card__progress">[2/5]</span>
    <!-- 标签在标题和日期之间，空间不足时折到下一行 -->
    <span class="gc-task-card__tags" style="display: flex; flex-wrap: wrap; gap: 3px;">
      <span class="gc-tag">#工作</span>
      <span class="gc-tag">#重要</span>
    </span>
    <span class="gc-task-card__due" style="flex-shrink: 0; margin-left: auto;">3天后 · 2/14</span>
  </div>
</div>
```

### 卡片背景与对齐
- **背景**：`transparent`（去掉白色底色，融入 Obsidian 背景）
- **hover**：`var(--background-modifier-hover)`（微弱高亮）
- **对齐**：所有内容左对齐，不居中

### 卡片内容
1. 左色带 3px（`::before` 伪元素，优先级色，已完成/取消时覆盖）
2. 状态图标（16px）：○ / ◐ / ✓ / ×（可点击循环切换）；提醒：🔔
3. 标题（提醒用斜体，flex-grow: 1）
4. 进度 [n/m]（父任务，flex-shrink: 0）
5. 标签 pills（空间充足时在标题后同行，不足时自动折行）
6. 倒计时 + 截止日期（右对齐，flex-shrink: 0，margin-left: auto）
   - ≤30天：`X天后 · M/D`（如 "3天后 · 2/14"）
   - >30天：`约X个月后 · M/D`（如 "约2个月后 · 4/15"）
   - 特殊：`今天 · M/D`、`明天 · M/D`、`后天 · M/D`
   - 过期：`已过期X天 · M/D`，文字红色 `#e5534b`

### 移除的功能
- 简洁/完整双模式切换（合并为单一模式）
- 「任务类型」标签（待办/提醒）— 改用图标+斜体区分
- 创建时间、开始时间等其他日期字段 — 只显示截止日期
- 自定义字段配置
- 不需要向后兼容旧设置

### 保留的功能
- 子任务树形展开/折叠
- 状态/标签/排序筛选
- 日期范围筛选
- 右键上下文菜单

---

## 6. 周视图（甘特图）

### 目标
短期规划，甘特图风格。改动最小，主要配色对齐。

### 甘特条样式
- 颜色逻辑：类型色（蓝/橙）→ **优先级色**（赤陶橙/清澈蓝/灰色）
- 待办条：实线 + 状态图标（○ / ◐ / ✓ / ×）
- 提醒条：实线 + 🔔 + 标题斜体（不再使用虚线区分类型）
- 已完成：绿色 `#3fb950` + 删除线 + opacity 0.5
- 已取消：灰色 `#8b949e` + 删除线 + opacity 0.4

### 层级区分
- 父任务：左色带 3px + 填充背景 (opacity 0.12) + **标题加粗 (font-weight: 600)** + 顶格显示
- 子任务 mini-bar：左色带 2px + 透明背景 + 正常字重 + **缩进 12-16px**
- 孙任务 mini-bar：左色带 2px 虚线 + 透明背景 + 正常字重 + **缩进 24-32px**

### 间距优化
- 甘特行高：26-28px
- 适当缩减行间距

### 保留的功能
- 子任务展开/折叠、进度标记 [n/m]
- hover tooltip、点击编辑
- 溢出指示器（左/右）
- rolling7 模式
- Header 日期头（高亮今天）

---

## 7. 全局间距优化

| 区域 | 现有 | 目标 |
|------|------|------|
| 月视图日格内边距 | 6-8px | 3px |
| 月视图任务条间距 | 4px | 1-2px |
| 月视图色带宽度 | - | 3px |
| 任务视图卡片间距 | 8px | 4px |
| 任务视图卡片内边距 | 10-12px | 6-8px |
| 任务视图色带宽度 | - | 3px |
| 周视图甘特行高 | 30-32px | 26-28px |
| 周视图父任务色带 | - | 3px |
| 周视图子任务色带 | - | 2px |
| 工具栏内边距 | 8-12px | 6-8px |

总体原则：全局缩减约 30-40% 间距。

---

## 8. CSS 变量规划

```css
/* ===== 优先级色 ===== */
--gc-priority-high: #d97757;
--gc-priority-normal: #6BB3E0;       /* 清澈蓝（亮/暗色主题相同） */
--gc-priority-low: #8b949e;          /* 暗色主题: #9aafbf */

/* ===== 状态色 ===== */
--gc-status-completed: #3fb950;
--gc-status-canceled: #8b949e;
--gc-status-overdue: #e5534b;

/* ===== 今天高亮 ===== */
--gc-today-bg: rgba(255, 107, 107, 0.08);

/* ===== 透明度 ===== */
--gc-completed-opacity: 0.5;
--gc-canceled-opacity: 0.4;
--gc-parent-fill-opacity: 0.12;

/* ===== 间距 ===== */
--gc-card-gap: 4px;
--gc-card-padding: 6px 8px;
--gc-month-cell-padding: 2px 3px;
--gc-month-task-gap: 1px;
--gc-gantt-row-height: 27px;

/* ===== 色带宽度 ===== */
--gc-band-width-default: 3px;    /* 月视图、任务视图、周视图父任务 */
--gc-band-width-child: 2px;      /* 周视图子/孙任务 */

/* ===== 状态图标尺寸 ===== */
--gc-icon-size-compact: 14px;   /* 月视图、周视图 */
--gc-icon-size-normal: 16px;    /* 任务视图 */
```

暗色主题覆盖：
```css
.theme-dark {
    --gc-priority-low: #9aafbf;    /* 低优先级灰色在暗色主题下调亮 */
    /* --gc-priority-normal 不变，#6BB3E0 在暗色主题下已足够亮 */
}
```

---

## 9. 需同步更新的组件

除三个视图外，以下组件也需更新以保持一致性：

| 组件 | 文件 | 变更 |
|------|------|------|
| 右键菜单 | `contextMenuIndex.ts` | 优先级图标更新、状态操作适配 4 种状态 |
| 编辑弹窗 | `BaseTaskModal.ts`, `EditTaskModal.ts` | 状态选择器从 7 种→4 种，移除自定义状态 |
| 创建弹窗 | `CreateTaskModal.ts` | 同上 |
| 筛选面板 | `view-menu.ts` | 状态筛选列表 7→4 |
| 悬浮提示 | `tooltipManager.ts` | 确保包含：标题、类型、优先级、状态、标签、所有日期、详情 |
| 设置页 | settings 相关文件 | 移除自定义状态配色设置，移除简洁/完整模式设置 |
| 任务更新器 | `taskUpdater.ts` | 新的状态循环逻辑 + 父子联动 |
| 状态定义 | `taskStatus.ts` | 7→4 种，移除马卡龙色卡和自定义状态支持 |
| BEM 类名 | `bem.ts` | 移除旧类名，添加新类名 |
| 优先级工具 | `priorityUtils.ts` | 更新图标和颜色映射 |

---

## 10. 实施计划

### Phase 1：基础设施（CSS + 组件）
1. 定义新 CSS 变量（§8）
2. 创建 `StatusIcon` 组件（§3）
3. 实现色带 `::before` 伪元素基础样式
4. 更新 `bem.ts` 类名定义
5. 更新 `priorityUtils.ts` 适配新色彩

### Phase 2：状态系统重构
1. 简化 `taskStatus.ts`（7→4 种，移除自定义状态 + 马卡龙色卡）
2. 更新 `taskUpdater.ts` — 状态循环切换逻辑（todo → in_progress → done → todo）
3. 实现父→子向下传播（递归 + 取消保护）
4. 实现子→父向上聚合（递归 + 防循环）
5. 数据迁移逻辑（旧状态自动转换）
6. 更新编辑弹窗、创建弹窗（状态选择器 7→4）
7. 更新右键菜单（状态操作）
8. 更新筛选面板（状态列表 7→4）

### Phase 3：月视图重构
1. 简化 `MonthView.config.ts`（移除标签等）
2. 集成 StatusIcon 组件
3. 重写任务条样式（色带 + 图标 + 标题 + 进度独立元素）
4. 调整间距
5. 更新 tooltip 确保信息完整

### Phase 4：任务视图重构
1. 合并简洁/完整双模式
2. 重写 `TaskView.config.ts`
3. 实现两行结构布局（主行 + 标签行）
4. 添加倒计时显示（含近期/远期格式化）
5. 集成 StatusIcon 组件

### Phase 5：周视图微调
1. 替换类型色为优先级色
2. 集成 StatusIcon 组件
3. 更新层级区分样式（色带 `::before` + 背景填充）
4. 调整行高和间距

### Phase 6：清理
1. 移除废弃 CSS 规则（旧状态色、旧类型色、旧优先级色等）
2. 移除 `taskStatus.ts` 中旧配色代码
3. 移除简洁/完整模式相关设置和类型
4. 移除自定义状态相关 UI 和设置
5. 移除 `bem.ts` 中未使用的旧类名
6. 移除设置页中的自定义状态配色区域
