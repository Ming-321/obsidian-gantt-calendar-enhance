# 子任务功能设计方案

**日期**：2026-02-10
**状态**：已确认

## 背景

大任务截止日期较远时，需要拆分为多个可执行的子任务分步推进。当前 `GCTask` 为扁平结构，不支持父子关系。

## 设计决策

| 维度 | 决定 |
|------|------|
| 嵌套深度 | 最多两层（父 → 子 → 孙） |
| 独立性 | 半独立（继承父属性，可覆盖） |
| 完成联动 | 自动推算（双向） |
| 数据存储 | 扁平存储 + `parentId` 引用 |
| 周视图 | 单 bar 展开/收起，默认展开一级 |
| 月视图 | 智能去重 + 颜色区分子任务 |
| 任务视图 | 树形展开/折叠 |
| 创建入口 | 编辑弹窗内 + 右键菜单 |

## 1. 数据模型变更

在 `GCTask` 接口中新增字段：

```typescript
export interface GCTask {
  // ... 现有字段保持不变 ...

  // 子任务关系
  parentId?: string;       // 父任务 ID（顶层任务无此字段）
  childIds?: string[];     // 子任务 ID 列表（维护顺序）
  depth?: number;          // 嵌套深度：0=顶层, 1=子任务, 2=子子任务
}
```

### 继承规则（创建子任务时的默认值）

- `dueDate` — 继承父任务，可覆盖
- `tags` — 继承父任务，可覆盖
- `priority` — 继承父任务，可覆盖
- `type` — 继承父任务（todo/reminder），可覆盖
- `startDate` — 默认为当前日期（不继承）
- `description`、`detail` — 不继承，必须自己填

### 深度限制

创建子任务时检查 `depth`，`depth >= 2` 时禁止再创建子任务。

### `childIds` 的作用

- 控制子任务的显示顺序
- 快速判断一个任务是否有子任务（`childIds.length > 0`）
- 删除父任务时快速找到所有子任务

## 2. 数据层变更

### JsonDataSource

**createTask**：
- 如果新任务携带 `parentId`，创建后自动将新任务 ID 追加到父任务的 `childIds`
- 验证：父任务必须存在且 `depth < 2`

**deleteTask**：
- 删除任务时，递归删除所有子任务（通过 `childIds` 遍历）
- 同时从父任务的 `childIds` 中移除自己

**updateTask** 完成状态联动：
- `completed` → `true`：将所有未完成子任务标记完成
- `completed` → `true`：检查所有兄弟任务是否都已完成 → 是则自动完成父任务
- `completed` → `false`（取消完成）：如果父任务已因此完成，也取消父任务完成状态

### TaskRepository 新增查询

- `getChildTasks(parentId: string): GCTask[]` — 获取直接子任务
- `getTaskTree(taskId: string): GCTask[]` — 获取任务及其所有后代
- `getRootTasks(): GCTask[]` — 获取所有顶层任务

### TaskStore 新增方法

- `createSubTask(parentId: string, task: Partial<GCTask>): Promise<string>` — 自动设置 `parentId`、`depth`，应用继承规则

## 3. 视图展示

### 周视图（甘特图）——单 bar 展开/收起

父任务和子任务在同一个 bar 内显示，bar 高度根据子任务数量动态增长：

**默认状态**（展开一级子任务）：
```
┌────────────────────────────┐
│ ▼ 写论文               [2/5] │  ← 父任务
│   □ 查资料            ✓     │  ← 子任务1（已完成）
│   □ 写大纲            ✓     │  ← 子任务2（已完成）
│   ▶ 写初稿                  │  ← 子任务3（有二级，折叠中）
│   □ 修改润色                │  ← 子任务4
│   □ 最终提交                │  ← 子任务5
└────────────────────────────┘
```

**完全折叠**：只显示父任务，bar 恢复正常高度，显示进度 `[2/5]`。

**完全展开**：bar 继续增高，显示二级子任务（更深缩进）。

**交互**：
- 点击三角图标切换展开/折叠
- 点击 bar 本身打开编辑弹窗

### 月视图——智能去重 + 颜色区分

- **同截止日**：父子截止日相同时，只显示父任务（附进度 `[2/5]`）
- **不同截止日**：子任务截止日早于父任务时，在该日期单独显示
- **子任务视觉区分**：子任务使用左侧边框加粗 + 浅渐变背景（如蓝色待办的子任务用浅蓝渐变）

### 任务视图——树形展示

- 父任务条目下方缩进显示子任务列表
- 支持展开/折叠
- 每个子任务条目有独立的复选框

## 4. UI 交互

### 编辑弹窗内的子任务区域

在 `BaseTaskModal` 底部新增"子任务"区域：

```
──────────────────────────
子任务                  [+ 添加]
──────────────────────────
  □ 查资料          📅 2/15  ✏️ 🗑️
  ✅ 写大纲          📅 2/10  ✏️ 🗑️
  □ 写初稿          📅 2/20  ✏️ 🗑️
──────────────────────────
[+ 快速添加子任务...]
──────────────────────────
```

- **快速添加**：底部输入框，输入描述回车即创建（自动继承父属性）
- **精细编辑**：点击 ✏️ 打开独立编辑弹窗
- **删除**：点击 🗑️ 确认后删除
- **状态切换**：点击复选框直接切换

### 右键菜单

任务右键菜单添加"添加子任务"选项（仅 `depth < 2` 时显示），打开 `CreateTaskModal` 并自动关联父任务。

### 创建任务弹窗

通过"添加子任务"入口打开时：
- 标题显示"添加子任务 - {父任务名}"
- 日期预填父任务截止日期
- 标签预选父任务标签

## 5. 实现注意事项

### 5.1 子任务区域仅在 EditTaskModal 中显示

子任务管理区域只在 `EditTaskModal` 中渲染（任务已存在时才能添加子任务）。`CreateTaskModal` 不显示此区域。当通过"添加子任务"入口打开 `CreateTaskModal` 时，仅预填父任务属性，不显示子任务区域。

### 5.2 完成联动防止无限循环

自动推算的两条规则（子全完成→父完成、父完成→子全完成）同时生效时，`updateTask` 内部会递归调用。需要在 `updateTask` 中添加 `options?: { skipCascade?: boolean }` 参数，联动触发的更新传入 `skipCascade: true` 以跳过再次联动检查。

### 5.3 JSON 序列化

`JsonTaskData` 接口、`taskToJson`、`jsonToTask` 函数均需新增 `parentId`、`childIds`、`depth` 字段的读写。这些字段都是原始类型/数组，无需特殊日期转换。

### 5.4 继承规则为"创建时复制"

创建子任务时，继承的字段（`dueDate`、`tags`、`priority`、`type`）直接复制到子任务的字段中，而非运行时动态查找父任务。这样每个子任务都是自包含的，过滤/排序/渲染逻辑不需要额外查询父任务。

### 5.5 排序逻辑

- 周视图/月视图：排序逻辑不需要改，父子任务按各自属性排序
- 任务视图（树形展示）：排序只在同级任务之间进行，子任务内部顺序由 `childIds` 数组控制

### 5.6 状态一致性

自动完成子任务时，除了设置 `completed = true`，还需同步设置 `status = 'done'` 和 `completionDate = new Date()`，确保状态字段一致。

### 5.7 月视图去重的边界情况

- 父任务无 `dueDate`，子任务有 `dueDate` → 子任务正常显示
- 父子 `dueDate` 相同 → 只显示父任务（附进度）
- 子任务 `dueDate` 早于或晚于父任务 → 子任务在其截止日单独显示
- 子任务无 `dueDate` → 按现有逻辑 fallback 到 `startDate`

### 5.8 周视图 bar 重写要点

这是工作量最大的部分。需要：
- 重写 `renderGanttRow` 支持多任务 bar 容器
- 新增 `expandedTasks: Set<string>` 状态管理展开/折叠
- bar 高度根据子任务数量动态计算（CSS `height: auto` 或计算值）
- `collectWeekTasks` 需要先收集根任务，再按需加载子任务

## 6. 兼容性

- 现有无子任务的任务不受影响（新字段均为可选）
- JSON 文件 `version` 不需要变更（向后兼容）
- GitHub 同步需要同步 `parentId`/`childIds`/`depth` 字段
- 旧格式备份数据（缺少新字段）导入时优雅降级为 `undefined`

## 7. 实施顺序

1. 数据模型 — `GCTask`/`TaskChanges`/`TaskUpdates`/`JsonTaskData` 新增字段，`taskToJson`/`jsonToTask` 更新
2. 数据层 — `JsonDataSource` CRUD 级联逻辑 + 防循环机制，`TaskRepository` 新增查询方法，`TaskStore` 新增 `createSubTask`
3. 编辑弹窗 — `EditTaskModal` 添加子任务管理区域，`CreateTaskModal` 支持 `parentTask` 参数
4. 任务视图 — 树形展示（最简单的视图改动，优先验证数据层正确性）
5. 周视图 — 单 bar 展开/收起（核心甘特图改动，工作量最大）
6. 月视图 — 智能去重 + 子任务颜色区分
7. 右键菜单 — `contextMenuIndex` 添加"添加子任务"选项
