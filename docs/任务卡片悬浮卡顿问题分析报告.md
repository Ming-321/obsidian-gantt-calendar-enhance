# ä»»åŠ¡å¡ç‰‡æ‚¬æµ®å¡é¡¿é—®é¢˜åˆ†ææŠ¥å‘Š

> **æŠ¥å‘Šç‰ˆæœ¬**: v2.0 (æ›´æ–°äº2024å¹´ï¼Œåæ˜ æœ€æ–°ä»£ç æ¶æ„)
> **åˆ†ææ—¥æœŸ**: 2025-12-28

## 1. é—®é¢˜æ¦‚è¿°

### 1.1 ç°è±¡æè¿°

| è§†å›¾ç±»å‹ | ä»»åŠ¡å¡ç‰‡æ‚¬æµ®å“åº” | æ˜¯å¦æœ‰tooltipæç¤ºçª— | å¡é¡¿ç¨‹åº¦ |
|---------|----------------|-------------------|---------|
| ä»»åŠ¡è§†å›¾ (TaskView) | å¿«é€Ÿå“åº” | âŒ æ—  | æ— å¡é¡¿ |
| æ—¥è§†å›¾ (DayView) | å¿«é€Ÿå“åº” | âŒ æ—  | æ— å¡é¡¿ |
| ç”˜ç‰¹å›¾è§†å›¾ (GanttView) | å¿«é€Ÿå“åº” | âŒ æ—  | æ— å¡é¡¿ |
| å‘¨è§†å›¾ (WeekView) | è¿Ÿé’/æ— å“åº” | âœ… æœ‰ | ä¸¥é‡å¡é¡¿ |
| æœˆè§†å›¾ (MonthView) | è¿Ÿé’/æ— å“åº” | âœ… æœ‰ | ä¸¥é‡å¡é¡¿ |

**æ ¸å¿ƒç—‡çŠ¶**ï¼š
- åœ¨å‘¨è§†å›¾å’Œæœˆè§†å›¾ä¸­ï¼Œé¼ æ ‡å¿«é€Ÿæ»‘è¿‡å¤šä¸ªä»»åŠ¡å¡ç‰‡æ—¶ï¼š
  - ä»»åŠ¡å¡ç‰‡ä½ç§»æ•ˆæœï¼ˆ`translateX`ï¼‰ç»å¸¸ä¸è§¦å‘
  - Tooltip æç¤ºçª—æ˜¾ç¤ºå»¶è¿Ÿæˆ–å®Œå…¨ä¸æ˜¾ç¤º
  - ä½“éªŒæ˜æ˜¾ä¸æµç•…

### 1.2 ç”¨æˆ·æ¨æµ‹éªŒè¯

> "è¯¥é—®é¢˜æ˜¯ç”±ä»»åŠ¡å¼¹çª—é€ æˆçš„ï¼Œå› ä¸ºæ—¥è§†å›¾å’Œä»»åŠ¡è§†å›¾æ²¡æœ‰å¼¹çª—åŠŸèƒ½ï¼Œå°±ä¸ä¼šå¡é¡¿ï¼Œè€Œå‘¨è§†å›¾å’Œæœˆè§†å›¾ç”±å¼¹çª—æç¤ºï¼Œå°±å¾ˆå¡é¡¿"

**éªŒè¯ç»“æœï¼šæ¨æµ‹æ­£ç¡® âœ…**

---

## 2. æœ€æ–°ä»£ç æ¶æ„åˆ†æ

### 2.1 ç»Ÿä¸€ç»„ä»¶æ¶æ„

å½“å‰ä»£ç å·²ç»é‡æ„ä¸ºä½¿ç”¨**ç»Ÿä¸€çš„ä»»åŠ¡å¡ç‰‡ç»„ä»¶**ï¼š

```
src/components/TaskCard/
â”œâ”€â”€ TaskCard.ts              # ä¸»ç»„ä»¶ TaskCardComponent
â”œâ”€â”€ TaskCardRenderer.ts      # æ¸²æŸ“å™¨ (åŒ…å« attachTooltip æ–¹æ³•)
â”œâ”€â”€ TaskCardConfig.ts        # ç±»å‹å®šä¹‰
â”œâ”€â”€ index.ts                 # å¯¼å‡ºå…¥å£
â””â”€â”€ presets/                 # å„è§†å›¾é¢„è®¾é…ç½®
    â”œâ”€â”€ TaskView.config.ts   # enableTooltip: false
    â”œâ”€â”€ DayView.config.ts    # enableTooltip: false
    â”œâ”€â”€ GanttView.config.ts # enableTooltip: false
    â”œâ”€â”€ WeekView.config.ts   # enableTooltip: true  âš ï¸
    â””â”€â”€ MonthView.config.ts  # enableTooltip: true  âš ï¸
```

### 2.2 æ¶æ„å›¾

```mermaid
classDiagram
    class TaskCardComponent {
        +render() TaskCardRenderResult
        -createCardElement()
        -applyStateModifiers()
        -renderChildren()
        -attachInteractions()
    }

    class TaskCardRenderer {
        +attachTooltip()
        +attachDragBehavior()
        +attachContextMenu()
        +createTaskCheckbox()
        +renderDescription()
        +renderTaskTags()
        +renderPriority()
        +renderTimeFields()
    }

    class TaskCardConfig {
        +viewModifier: string
        +showCheckbox: boolean
        +showDescription: boolean
        +showTags: boolean
        +showPriority: boolean
        +showTimes: boolean
        +enableTooltip: boolean
        +enableDrag: boolean
        +clickable: boolean
        +compact: boolean
    }

    class ViewPreset {
        <<enumeration>>
        TaskViewConfig
        DayViewConfig
        GanttViewConfig
        WeekViewConfig
        MonthViewConfig
    }

    TaskCardComponent --> TaskCardRenderer: ä½¿ç”¨
    TaskCardComponent --> TaskCardConfig: é…ç½®
    ViewPreset ..|> TaskCardConfig: é¢„è®¾
    WeekViewRenderer --> TaskCardComponent: è°ƒç”¨
    MonthViewRenderer --> TaskCardComponent: è°ƒç”¨
```

### 2.3 å„è§†å›¾é…ç½®å¯¹æ¯”

| é…ç½®é¡¹ | TaskView | DayView | GanttView | WeekView | MonthView |
|-------|----------|---------|-----------|----------|-----------|
| `enableTooltip` | âŒ false | âŒ false | âŒ false | âœ… **true** | âœ… **true** |
| `enableDrag` | false | false | false | true | false |
| `showCheckbox` | true | true | true | true | true |
| `showDescription` | true | true | true | true | true |
| `showTags` | true | true | true | true | true |
| `showPriority` | true | true | true | true | false |
| `showTimes` | true | false | false | false | false |
| `compact` | false | false | false | false | true |
| `maxLines` | - | - | - | - | 1 |

### 2.4 ä»£ç è°ƒç”¨ç¤ºä¾‹

**WeekView.ts** (å‘¨è§†å›¾ - æœ‰å¡é¡¿):
```typescript
// src/views/WeekView.ts:162-178
private renderTaskItem(task: GanttTask, container: HTMLElement, targetDate: Date): void {
    new TaskCardComponent({
        task,
        config: WeekViewConfig,  // â† enableTooltip: true
        container,
        app: this.app,
        plugin: this.plugin,
        targetDate,
        onClick: (task) => { /* ... */ },
    }).render();
}
```

**TaskView.ts** (ä»»åŠ¡è§†å›¾ - æ— å¡é¡¿):
```typescript
// ç±»ä¼¼è°ƒç”¨ï¼Œä½†ä½¿ç”¨ TaskViewConfig
// config: TaskViewConfig,  // â† enableTooltip: false
```

### 2.5 ç»“è®º

**å¡é¡¿çš„ç›´æ¥åŸå› **ï¼š`WeekViewConfig` å’Œ `MonthViewConfig` è®¾ç½®äº† `enableTooltip: true`ï¼Œå¯¼è‡´ `TaskCardRenderer.attachTooltip()` æ–¹æ³•è¢«è°ƒç”¨ï¼Œè€Œå…¶ä»–è§†å›¾çš„é…ç½®ä¸­ `enableTooltip: false`ã€‚

---

## 3. attachTooltip æ–¹æ³•æ€§èƒ½ç“¶é¢ˆåˆ†æ

### 3.1 æ–¹æ³•å®ç°æ¦‚è§ˆ

```typescript
// src/components/TaskCard/TaskCardRenderer.ts:343-458
attachTooltip(card: HTMLElement, task: GanttTask): void {
    let tooltip: HTMLElement | null = null;
    let hideTimeout: number | null = null;
    const cleaned = task.description;

    const showTooltip = (e: MouseEvent) => {
        // æ¯æ¬¡é¼ æ ‡è¿›å…¥éƒ½æ‰§è¡Œï¼š
        if (tooltip) {
            tooltip.remove();  // é”€æ¯æ—§ tooltip
        }

        // 1. åˆ›å»ºæ–° tooltip DOM
        tooltip = document.body.createDiv('gc-task-tooltip');

        // 2. å¡«å……å†…å®¹ï¼ˆåˆ›å»ºå¤šä¸ªå­å…ƒç´ ï¼‰
        const descDiv = tooltip.createDiv('gc-task-tooltip__description');
        descDiv.createEl('strong', { text: cleaned });
        // ... ä¼˜å…ˆçº§ã€æ—¶é—´å±æ€§ã€æ ‡ç­¾ã€æ–‡ä»¶ä½ç½® ...

        // 3. è®¡ç®—å®šä½ï¼ˆè§¦å‘é‡æ’ï¼‰
        const rect = card.getBoundingClientRect();
        // ... è¾¹ç•Œæ£€æµ‹ ...

        // 4. å»¶è¿Ÿæ˜¾ç¤º
        setTimeout(() => {
            tooltip.style.opacity = '1';
        }, 10);
    };

    const hideTooltip = () => {
        // å»¶è¿Ÿéšè—
    };

    card.addEventListener('mouseenter', showTooltip);
    card.addEventListener('mouseleave', hideTooltip);
}
```

### 3.2 æ€§èƒ½é—®é¢˜è¯¦ç»†åˆ†æ

#### é—®é¢˜1: æ¯æ¬¡Hoveréƒ½åˆ›å»ºå®Œæ•´çš„DOMç»“æ„

**é—®é¢˜ä»£ç **ï¼š
```typescript
// BaseCalendarRenderer.ts:227
tooltip = document.body.createDiv('gc-task-tooltip');
```

**æ€§èƒ½å½±å“**ï¼š
- æ¯æ¬¡é¼ æ ‡è¿›å…¥éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ `div` å…ƒç´ 
- Tooltip åŒ…å«å¤æ‚çš„åµŒå¥—ç»“æ„ï¼š
  ```
  .gc-task-tooltip
  â”œâ”€â”€ .gc-task-tooltip__description (strong)
  â”œâ”€â”€ .gc-task-tooltip__priority (span)
  â”œâ”€â”€ .gc-task-tooltip__times (å¤šä¸ª .gc-task-tooltip__time-item)
  â”œâ”€â”€ .gc-task-tooltip__tags (å¤šä¸ª span.gc-tag)
  â””â”€â”€ .gc-task-tooltip__file (span)
  ```
- æ·»åŠ åˆ° `document.body` ä¼šè§¦å‘**å…¨å±€é‡æ’ï¼ˆreflowï¼‰**
- DOM æ“ä½œæ˜¯åŒæ­¥é˜»å¡çš„ï¼Œä¼šç«‹å³å½±å“ä¸»çº¿ç¨‹

#### é—®é¢˜2: å¼ºåˆ¶åŒæ­¥å¸ƒå±€è®¡ç®— (Forced Synchronous Layout)

**é—®é¢˜ä»£ç **ï¼š
```typescript
// BaseCalendarRenderer.ts:299-301
const rect = taskItem.getBoundingClientRect();  // â† è§¦å‘é‡æ’
const tooltipWidth = 300;
const tooltipHeight = tooltip.offsetHeight;     // â† å†æ¬¡è§¦å‘é‡æ’ï¼
```

**æ€§èƒ½å½±å“**ï¼š
- `getBoundingClientRect()` å¼ºåˆ¶æµè§ˆå™¨è®¡ç®—å…ƒç´ çš„å‡ ä½•ä¿¡æ¯
- `offsetHeight` è¯»å–ä¹Ÿä¼šè§¦å‘é‡æ’
- åœ¨é¢‘ç¹çš„ mouseenter äº‹ä»¶ä¸­æ‰§è¡Œä¼šå¯¼è‡´å¸ƒå±€æŠ–åŠ¨
- æ¯ç§’å¯èƒ½è§¦å‘æ•°åæ¬¡ï¼Œæ¯æ¬¡éƒ½å¼ºåˆ¶æµè§ˆå™¨é‡æ–°è®¡ç®—å¸ƒå±€

#### é—®é¢˜3: Tooltipå®šä½è®¡ç®—å¤æ‚

**é—®é¢˜ä»£ç **ï¼š
```typescript
// BaseCalendarRenderer.ts:303-319
let left = rect.right + 10;
let top = rect.top;

if (left + tooltipWidth > window.innerWidth) {
    left = rect.left - tooltipWidth - 10;
}
if (left < 0) {
    left = (window.innerWidth - tooltipWidth) / 2;
}
if (top + tooltipHeight > window.innerHeight) {
    top = window.innerHeight - tooltipHeight - 10;
}
if (top < 0) {
    top = 10;
}
```

**æ€§èƒ½å½±å“**ï¼š
- å¤šæ¬¡æ¡ä»¶åˆ¤æ–­å’Œè¾¹ç•Œè®¡ç®—
- éœ€è¦è¯»å– `window.innerWidth` å’Œ `window.innerHeight`
- è¿™äº›è¯»å–æ“ä½œåœ¨é¢‘ç¹è°ƒç”¨æ—¶ä¼šäº§ç”Ÿç´¯ç§¯å¼€é”€

#### é—®é¢˜4: æ¸…ç†æ“ä½œä½¿ç”¨æŸ¥è¯¢é€‰æ‹©å™¨

**é—®é¢˜ä»£ç **ï¼š
```typescript
// BaseCalendarRenderer.ts:166
protected clearTaskTooltips(): void {
    const tooltips = document.querySelectorAll('.calendar-week-task-tooltip, .gc-task-tooltip');
    tooltips.forEach(t => t.remove());
}
```

**æ€§èƒ½å½±å“**ï¼š
- `querySelectorAll` ä¼šéå†æ•´ä¸ª DOM æ ‘
- åœ¨æ¯æ¬¡ checkbox change æ—¶è°ƒç”¨ (line 181)
- å½“é¡µé¢æœ‰å¤§é‡ä»»åŠ¡å¡ç‰‡æ—¶ï¼Œè¿™ä¸ªæ“ä½œå¾ˆæ˜‚è´µ

#### é—®é¢˜5: å»¶è¿Ÿæ˜¾ç¤ºçš„setTimeout

**é—®é¢˜ä»£ç **ï¼š
```typescript
// BaseCalendarRenderer.ts:324-329
setTimeout(() => {
    if (tooltip) {
        tooltip.style.opacity = '1';
        tooltip.addClass('gc-task-tooltip--visible');
    }
}, 10);
```

**æ€§èƒ½å½±å“**ï¼š
- 10ms å»¶è¿Ÿæ„å‘³ç€ tooltip æ˜¾ç¤ºæ€»æ˜¯æ»å
- å½“é¼ æ ‡å¿«é€Ÿç§»åŠ¨æ—¶ï¼Œç”¨æˆ·å¯èƒ½å·²ç»ç§»å¼€ï¼Œtooltip è¿˜åœ¨æ˜¾ç¤º
- å¤šä¸ªå®šæ—¶å™¨åŒæ—¶å­˜åœ¨æ—¶ä¼šäº’ç›¸å¹²æ‰°

#### é—®é¢˜6: CSS Transition ä¸å¿«é€ŸHoverå†²çª

**CSSæ ·å¼**ï¼š
```css
/* styles.css:1272-1273 */
transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1),
            transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
```

**æ€§èƒ½å½±å“**ï¼š
- 200ms çš„è¿‡æ¸¡æ—¶é—´åœ¨å¿«é€Ÿ hover æ—¶æ˜¾å¾—å¤ªæ…¢
- æ¯æ¬¡æ˜¾ç¤º/éšè—éƒ½è¦ç­‰å¾…åŠ¨ç”»å®Œæˆ
- å¤šä¸ª tooltip åŒæ—¶è¿›è¡Œè¿‡æ¸¡ä¼šæ¶ˆè€— GPU èµ„æº

### 3.3 æ€§èƒ½ç“¶é¢ˆæµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·é¼ æ ‡
    participant Card as ä»»åŠ¡å¡ç‰‡
    participant Tooltip as createTaskTooltip
    participant DOM as DOMå¼•æ“
    participant Layout as å¸ƒå±€å¼•æ“
    participant Paint as æ¸²æŸ“å¼•æ“

    User->>Card: mouseenter äº‹ä»¶
    Card->>Tooltip: è§¦å‘ showTooltip

    Note over Tooltip,DOM: === æ€§èƒ½ç“¶é¢ˆå¼€å§‹ ===
    Tooltip->>DOM: clearTaskTooltips()
    DOM->>DOM: querySelectorAll å…¨å±€æŸ¥è¯¢

    Tooltip->>DOM: createDiv('gc-task-tooltip')
    DOM->>Layout: åˆ›å»ºæ–°å…ƒç´ è§¦å‘é‡æ’

    Tooltip->>DOM: å¡«å……å†…å®¹ï¼ˆæè¿°ã€ä¼˜å…ˆçº§ã€æ—¶é—´...ï¼‰
    DOM->>Layout: å¤šæ¬¡DOMæ“ä½œç´¯ç§¯é‡æ’

    Tooltip->>Layout: getBoundingClientRect()
    Layout->>Layout: å¼ºåˆ¶åŒæ­¥å¸ƒå±€è®¡ç®—

    Tooltip->>Layout: offsetHeight
    Layout->>Layout: å†æ¬¡å¼ºåˆ¶å¸ƒå±€è®¡ç®—

    Tooltip->>Layout: è®¡ç®—å®šä½ï¼ˆè¾¹ç•Œæ£€æµ‹ï¼‰
    Layout->>Layout: å¤šæ¬¡è¯»å–çª—å£å°ºå¯¸

    Tooltip->>DOM: è®¾ç½® left/top æ ·å¼
    DOM->>Layout: è§¦å‘é‡æ’

    Tooltip->>DOM: setTimeout(10ms)
    Note over DOM,Paint: 10mså...
    Tooltip->>DOM: è®¾ç½® opacity=1
    DOM->>Paint: CSS transition 200ms
    Paint->>Paint: GPU åˆæˆåŠ¨ç”»
    Note over Tooltip,Paint: === æ€§èƒ½ç“¶é¢ˆç»“æŸ ===

    User->>Card: å¿«é€Ÿç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¡ç‰‡
    Note over User: å¡é¡¿å·²å‘ç”Ÿï¼Œç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ
```

---

## 4. å¡é¡¿åœºæ™¯åˆ†æ

### 4.1 å•ä¸ªä»»åŠ¡å¡ç‰‡Hover

```
æ—¶é—´çº¿: 0ms ---- 10ms ---- 210ms ----
         â†“      â†“        â†“
       åˆ›å»º   æ˜¾ç¤º    åŠ¨ç”»å®Œæˆ
      DOM    opacity   (200ms)
```

### 4.2 å¿«é€Ÿæ»‘è¿‡å¤šä¸ªä»»åŠ¡å¡ç‰‡

```
å¡ç‰‡1: [mouseenter â†’ åˆ›å»ºDOM â†’ è®¡ç®—å¸ƒå±€ â†’ setTimeout...] â† è¢«æ‰“æ–­
å¡ç‰‡2:    [mouseenter â†’ åˆ›å»ºDOM â†’ è®¡ç®—å¸ƒå±€ â†’ setTimeout...] â† è¢«æ‰“æ–­
å¡ç‰‡3:       [mouseenter â†’ åˆ›å»ºDOM â†’ è®¡ç®—å¸ƒå±€ â†’ setTimeout...]
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªå¡ç‰‡éƒ½è§¦å‘å®Œæ•´çš„ tooltip åˆ›å»ºæµç¨‹
- å‰ä¸€ä¸ª tooltip è¿˜æ²¡æ˜¾ç¤ºå®Œå°±è¢«æ¸…ç†
- å¤§é‡çš„æ— æ•ˆè®¡ç®—å’Œ DOM æ“ä½œ

### 4.3 ä»»åŠ¡å¡ç‰‡ä½ç§»æ•ˆæœä¸Tooltipçš„å†²çª

**CSS hoveræ•ˆæœ**ï¼š
```css
/* styles.css:2387-2391 */
.gc-task-card--week:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
```

**å†²çªåŸå› **ï¼š
1. å¡ç‰‡ä½ç§»æ˜¯ CSS `:hover` ä¼ªç±»æ§åˆ¶çš„
2. Tooltip æ˜¾ç¤ºéœ€è¦åœ¨ JavaScript çš„ `mouseenter` äº‹ä»¶ä¸­å¤„ç†
3. å½“ Tooltip åˆ›å»ºè€—æ—¶è¿‡é•¿æ—¶ï¼Œä¼šé˜»å¡äº‹ä»¶å¾ªç¯
4. å¯¼è‡´ CSS çš„ `:hover` çŠ¶æ€æ›´æ–°å»¶è¿Ÿ

---

## 5. æ ¸å¿ƒåŸå› æ€»ç»“

### 5.1 ç›´æ¥åŸå› 

| æ’å | é—®é¢˜ | æ€§èƒ½å½±å“ | ä¸¥é‡æ€§ |
|-----|------|---------|-------|
| 1 | æ¯æ¬¡hoveråˆ›å»ºå®Œæ•´DOM | é«˜ | ğŸ”´ ä¸¥é‡ |
| 2 | å¼ºåˆ¶åŒæ­¥å¸ƒå±€è®¡ç®— | é«˜ | ğŸ”´ ä¸¥é‡ |
| 3 | å…¨å±€querySelectorAllæ¸…ç† | ä¸­ | ğŸŸ¡ ä¸­ç­‰ |
| 4 | CSS transition 200mså»¶è¿Ÿ | ä¸­ | ğŸŸ¡ ä¸­ç­‰ |
| 5 | å¤æ‚çš„å®šä½è®¡ç®— | ä½ | ğŸŸ¢ è½»å¾® |

### 5.2 æ ¹æœ¬åŸå› 

**è®¾è®¡é—®é¢˜**ï¼š`createTaskTooltip` é‡‡ç”¨äº†"å³æ—¶åˆ›å»ºã€ç”¨å®Œå³å¼ƒ"çš„æ¨¡å¼ï¼Œè€Œä¸æ˜¯"å¤ç”¨å•ä¸€å®ä¾‹"çš„æ¨¡å¼ã€‚

```typescript
// å½“å‰å®ç°ï¼ˆä½æ•ˆï¼‰ï¼š
mouseenter â†’ åˆ›å»ºæ–°tooltip â†’ å¡«å……å†…å®¹ â†’ æ˜¾ç¤º â†’ mouseleave â†’ é”€æ¯
mouseenter â†’ åˆ›å»ºæ–°tooltip â†’ å¡«å……å†…å®¹ â†’ æ˜¾ç¤º â†’ mouseleave â†’ é”€æ¯
...

// æ›´å¥½çš„å®ç°ï¼ˆé«˜æ•ˆï¼‰ï¼š
åˆ›å»ºtooltipæ±  â†’ hoveræ—¶å¤ç”¨ â†’ æ›´æ–°å†…å®¹ â†’ å®šä½ â†’ æ˜¾ç¤º
```

---

## 6. ä¼˜åŒ–å»ºè®®è¯¦è§£

### 6.1 æ–¹æ¡ˆA: Tooltipå¤ç”¨ï¼ˆå¼ºçƒˆæ¨èï¼‰

#### 6.1.1 é—®é¢˜åˆ†æ

å½“å‰å®ç°ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡å¡ç‰‡éƒ½åˆ›å»ºç‹¬ç«‹çš„ tooltipï¼š

```typescript
// å½“å‰ä½æ•ˆå®ç° (BaseCalendarRenderer.ts:228)
let tooltip: HTMLElement | null = null;  // æ¯ä¸ªä»»åŠ¡å¡ç‰‡ç‹¬ç«‹çš„é—­åŒ…å˜é‡

const showTooltip = (e: MouseEvent) => {
    if (tooltip) {
        tooltip.remove();  // é”€æ¯æ—§çš„
    }
    tooltip = document.body.createDiv('gc-task-tooltip');  // åˆ›å»ºæ–°çš„
    // ... å¡«å……å†…å®¹ ...
};
```

**æ€§èƒ½å¼€é”€å¯¹æ¯”**ï¼š

| æ“ä½œ | å½“å‰å®ç° | Tooltipå¤ç”¨ |
|-----|---------|------------|
| DOMåˆ›å»º | æ¯æ¬¡hoveråˆ›å»º | ä»…é¦–æ¬¡åˆ›å»º |
| DOMé”€æ¯ | æ¯æ¬¡hoveré”€æ¯ | è§†å›¾é”€æ¯æ—¶æ¸…ç† |
| é‡æ’æ¬¡æ•° | æ¯æ¬¡hover | é¦–æ¬¡ + å°‘é‡æ›´æ–° |
| å†…å­˜åˆ†é… | é¢‘ç¹åˆ†é…/å›æ”¶ | ç¨³å®š |

#### 6.1.2 å®Œæ•´å®ç°ä»£ç 

**æ­¥éª¤1ï¼šåˆ›å»º TooltipManager å•ä¾‹ç±»**

```typescript
// src/utils/tooltipManager.ts
import type { GanttTask } from '../types';
import { formatDate } from '../dateUtils/dateUtilsIndex';

interface TooltipConfig {
    showDelay?: number;
    hideDelay?: number;
}

/**
 * Tooltip å•ä¾‹ç®¡ç†å™¨
 * å…¨å±€å…±äº«ä¸€ä¸ª tooltip å…ƒç´ ï¼Œé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯ DOM
 */
export class TooltipManager {
    private static instance: TooltipManager | null = null;
    private tooltip: HTMLElement | null = null;
    private currentTaskItem: HTMLElement | null = null;
    private currentTask: GanttTask | null = null;
    private cleanedDescription: string = '';

    private showTimeout: number | null = null;
    private hideTimeout: number | null = null;

    private readonly config: Required<TooltipConfig>;

    // DOM å…ƒç´ ç¼“å­˜ï¼ˆé¿å…é‡å¤æŸ¥è¯¢ï¼‰
    private cachedElements: {
        description?: HTMLElement;
        priority?: HTMLElement;
        times?: HTMLElement;
        tags?: HTMLElement;
        file?: HTMLElement;
    } = {};

    private constructor(private plugin: any, config: TooltipConfig = {}) {
        this.config = {
            showDelay: config.showDelay ?? 0,    // å¯é…ç½®æ˜¾ç¤ºå»¶è¿Ÿ
            hideDelay: config.hideDelay ?? 100   // éšè—å»¶è¿Ÿ
        };
    }

    /**
     * è·å–å•ä¾‹å®ä¾‹
     */
    static getInstance(plugin: any, config?: TooltipConfig): TooltipManager {
        if (!TooltipManager.instance) {
            TooltipManager.instance = new TooltipManager(plugin, config);
        }
        return TooltipManager.instance;
    }

    /**
     * åˆå§‹åŒ– tooltipï¼ˆæ‡’åŠ è½½ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºï¼‰
     */
    private ensureTooltip(): HTMLElement {
        if (!this.tooltip) {
            this.tooltip = document.body.createDiv('gc-task-tooltip');
            this.tooltip.style.opacity = '0';

            // é¢„åˆ›å»ºæ‰€æœ‰å­å…ƒç´ ï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
            this.cachedElements.description = this.tooltip.createDiv('gc-task-tooltip__description');
            this.cachedElements.priority = this.tooltip.createDiv('gc-task-tooltip__priority');
            this.cachedElements.times = this.tooltip.createDiv('gc-task-tooltip__times');
            this.cachedElements.tags = this.tooltip.createDiv('gc-task-tooltip__tags');
            this.cachedElements.file = this.tooltip.createDiv('gc-task-tooltip__file');

            // åˆå§‹éšè—éƒ¨åˆ†å…ƒç´ 
            this.cachedElements.priority.style.display = 'none';
            this.cachedElements.times.style.display = 'none';
            this.cachedElements.tags.style.display = 'none';

            // è®¾ç½®åˆå§‹æ ·å¼
            this.tooltip.addClass('gc-task-tooltip--initialized');
        }
        return this.tooltip;
    }

    /**
     * æ˜¾ç¤º tooltip
     */
    show(task: GanttTask, taskItem: HTMLElement, cleaned: string): void {
        // å–æ¶ˆéšè—å®šæ—¶å™¨
        if (this.hideTimeout) {
            window.clearTimeout(this.hideTimeout);
            this.hideTimeout = null;
        }

        // å¦‚æœæ˜¯åŒä¸€ä¸ªä»»åŠ¡ï¼Œåªæ›´æ–°ä½ç½®
        if (this.currentTask === task && this.currentTaskItem === taskItem) {
            this.updatePosition(taskItem);
            return;
        }

        // ä¿å­˜å½“å‰çŠ¶æ€
        this.currentTask = task;
        this.currentTaskItem = taskItem;
        this.cleanedDescription = cleaned;

        // ä½¿ç”¨æ˜¾ç¤ºå»¶è¿Ÿï¼ˆå¯é€‰ï¼‰
        if (this.config.showDelay > 0) {
            if (this.showTimeout) {
                window.clearTimeout(this.showTimeout);
            }
            this.showTimeout = window.setTimeout(() => {
                this.showInternal(task, taskItem, cleaned);
            }, this.config.showDelay);
        } else {
            this.showInternal(task, taskItem, cleaned);
        }
    }

    /**
     * å†…éƒ¨æ˜¾ç¤ºé€»è¾‘
     */
    private showInternal(task: GanttTask, taskItem: HTMLElement, cleaned: string): void {
        const tooltip = this.ensureTooltip();

        // æ›´æ–°å†…å®¹ï¼ˆå¤ç”¨ç°æœ‰å…ƒç´ ï¼‰
        this.updateContent(task, cleaned);

        // æ›´æ–°ä½ç½®
        this.updatePosition(taskItem);

        // æ˜¾ç¤º
        tooltip.style.opacity = '1';
        tooltip.addClass('gc-task-tooltip--visible');
    }

    /**
     * æ›´æ–° tooltip å†…å®¹
     */
    private updateContent(task: GanttTask, cleaned: string): void {
        if (!this.cachedElements.description) return;

        // æ›´æ–°æè¿°
        const gf = (this.plugin?.settings?.globalTaskFilter || '').trim();
        const displayText = this.plugin?.settings?.showGlobalFilterInTaskText && gf
            ? `${gf} ${cleaned}`
            : cleaned;
        this.cachedElements.description.innerHTML = `<strong>${this.escapeHtml(displayText)}</strong>`;

        // æ›´æ–°ä¼˜å…ˆçº§
        if (task.priority && this.cachedElements.priority) {
            const priorityIcon = this.getPriorityIcon(task.priority);
            this.cachedElements.priority.innerHTML = `<span class="priority-${task.priority}">${priorityIcon} ä¼˜å…ˆçº§: ${task.priority}</span>`;
            this.cachedElements.priority.style.display = '';
        } else if (this.cachedElements.priority) {
            this.cachedElements.priority.style.display = 'none';
        }

        // æ›´æ–°æ—¶é—´å±æ€§
        if (this.cachedElements.times) {
            const hasTimeProperties = task.createdDate || task.startDate || task.scheduledDate ||
                task.dueDate || task.cancelledDate || task.completionDate;

            if (hasTimeProperties) {
                const timeHtml: string[] = [];

                if (task.createdDate) {
                    timeHtml.push(`<div class="gc-task-tooltip__time-item">â• åˆ›å»º: ${formatDate(task.createdDate, 'yyyy-MM-dd')}</div>`);
                }
                if (task.startDate) {
                    timeHtml.push(`<div class="gc-task-tooltip__time-item">ğŸ›« å¼€å§‹: ${formatDate(task.startDate, 'yyyy-MM-dd')}</div>`);
                }
                if (task.scheduledDate) {
                    timeHtml.push(`<div class="gc-task-tooltip__time-item">â³ è®¡åˆ’: ${formatDate(task.scheduledDate, 'yyyy-MM-dd')}</div>`);
                }
                if (task.dueDate) {
                    const overdueClass = task.dueDate < new Date() && !task.completed
                        ? ' gc-task-tooltip__time-item--overdue'
                        : '';
                    timeHtml.push(`<div class="gc-task-tooltip__time-item${overdueClass}">ğŸ“… æˆªæ­¢: ${formatDate(task.dueDate, 'yyyy-MM-dd')}</div>`);
                }
                if (task.cancelledDate) {
                    timeHtml.push(`<div class="gc-task-tooltip__time-item">âŒ å–æ¶ˆ: ${formatDate(task.cancelledDate, 'yyyy-MM-dd')}</div>`);
                }
                if (task.completionDate) {
                    timeHtml.push(`<div class="gc-task-tooltip__time-item">âœ… å®Œæˆ: ${formatDate(task.completionDate, 'yyyy-MM-dd')}</div>`);
                }

                this.cachedElements.times.innerHTML = timeHtml.join('');
                this.cachedElements.times.style.display = '';
            } else {
                this.cachedElements.times.style.display = 'none';
            }
        }

        // æ›´æ–°æ ‡ç­¾
        if (this.cachedElements.tags) {
            if (task.tags && task.tags.length > 0) {
                const tagsHtml = task.tags.map(tag =>
                    `<span class="gc-tag gc-tag--tooltip">#${this.escapeHtml(tag)}</span>`
                ).join('');
                this.cachedElements.tags.innerHTML = `<span class="gc-task-tooltip__label">æ ‡ç­¾ï¼š</span>${tagsHtml}`;
                this.cachedElements.tags.style.display = '';
            } else {
                this.cachedElements.tags.style.display = 'none';
            }
        }

        // æ›´æ–°æ–‡ä»¶ä½ç½®
        if (this.cachedElements.file) {
            this.cachedElements.file.innerHTML = `<span class="gc-task-tooltip__file-location">ğŸ“„ ${task.fileName}:${task.lineNumber}</span>`;
        }
    }

    /**
     * æ›´æ–° tooltip ä½ç½®
     */
    private updatePosition(taskItem: HTMLElement): void {
        if (!this.tooltip) return;

        const rect = taskItem.getBoundingClientRect();
        const tooltipWidth = 300;
        // ä½¿ç”¨å›ºå®šé«˜åº¦é¿å…è¯»å– offsetHeight è§¦å‘é‡æ’
        const tooltipHeight = this.estimateTooltipHeight();

        let left = rect.right + 10;
        let top = rect.top;

        // è¾¹ç•Œæ£€æµ‹
        if (left + tooltipWidth > window.innerWidth) {
            left = rect.left - tooltipWidth - 10;
        }
        if (left < 10) {
            left = 10;
        }
        if (top + tooltipHeight > window.innerHeight) {
            top = window.innerHeight - tooltipHeight - 10;
        }
        if (top < 10) {
            top = 10;
        }

        this.tooltip.style.left = `${left}px`;
        this.tooltip.style.top = `${top}px`;
    }

    /**
     * ä¼°ç®— tooltip é«˜åº¦ï¼ˆé¿å…è¯»å– offsetHeightï¼‰
     */
    private estimateTooltipHeight(): number {
        // åŸºäºå†…å®¹ä¼°ç®—é«˜åº¦
        let height = 60; // åŸºç¡€é«˜åº¦ï¼ˆæè¿° + æ–‡ä»¶ï¼‰

        if (this.currentTask?.priority) height += 30;
        if (this.currentTask?.createdDate) height += 20;
        if (this.currentTask?.startDate) height += 20;
        if (this.currentTask?.scheduledDate) height += 20;
        if (this.currentTask?.dueDate) height += 20;
        if (this.currentTask?.cancelledDate) height += 20;
        if (this.currentTask?.completionDate) height += 20;
        if (this.currentTask?.tags && this.currentTask.tags.length > 0) height += 30;

        return Math.min(height, 400); // æœ€å¤§é«˜åº¦é™åˆ¶
    }

    /**
     * éšè— tooltip
     */
    hide(): void {
        // å–æ¶ˆæ˜¾ç¤ºå®šæ—¶å™¨
        if (this.showTimeout) {
            window.clearTimeout(this.showTimeout);
            this.showTimeout = null;
        }

        // å»¶è¿Ÿéšè—
        this.hideTimeout = window.setTimeout(() => {
            if (this.tooltip) {
                this.tooltip.removeClass('gc-task-tooltip--visible');
                this.tooltip.style.opacity = '0';
            }
        }, this.config.hideDelay);
    }

    /**
     * é”€æ¯ tooltip
     */
    destroy(): void {
        if (this.showTimeout) {
            window.clearTimeout(this.showTimeout);
            this.showTimeout = null;
        }
        if (this.hideTimeout) {
            window.clearTimeout(this.hideTimeout);
            this.hideTimeout = null;
        }
        if (this.tooltip) {
            this.tooltip.remove();
            this.tooltip = null;
        }
        this.cachedElements = {};
        this.currentTask = null;
        this.currentTaskItem = null;
    }

    /**
     * è·å–ä¼˜å…ˆçº§å›¾æ ‡
     */
    private getPriorityIcon(priority?: string): string {
        switch (priority) {
            case 'highest': return 'ğŸ”º';
            case 'high': return 'â«';
            case 'medium': return 'ğŸ”¼';
            case 'low': return 'ğŸ”½';
            case 'lowest': return 'â¬';
            default: return '';
        }
    }

    /**
     * HTML è½¬ä¹‰
     */
    private escapeHtml(text: string): string {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * é‡ç½®å•ä¾‹ï¼ˆç”¨äºæµ‹è¯•æˆ–é‡ç½®ï¼‰
     */
    static reset(): void {
        if (TooltipManager.instance) {
            TooltipManager.instance.destroy();
            TooltipManager.instance = null;
        }
    }
}
```

**æ­¥éª¤2ï¼šä¿®æ”¹ BaseCalendarRenderer**

```typescript
// src/views/BaseCalendarRenderer.ts
import { TooltipManager } from '../utils/tooltipManager';

export abstract class BaseCalendarRenderer {
    // ... å…¶ä»–ä»£ç  ...

    /**
     * åˆ›å»ºä»»åŠ¡æ‚¬æµ®æç¤ºï¼ˆä½¿ç”¨ TooltipManagerï¼‰
     */
    protected createTaskTooltip(
        task: GanttTask,
        taskItem: HTMLElement,
        cleaned: string
    ): void {
        // è·å– TooltipManager å•ä¾‹
        const tooltipManager = TooltipManager.getInstance(this.plugin);

        taskItem.addEventListener('mouseenter', () => {
            tooltipManager.show(task, taskItem, cleaned);
        });

        taskItem.addEventListener('mouseleave', () => {
            tooltipManager.hide();
        });

        // æ³¨å†Œæ¸…ç†å›è°ƒ
        this.registerDomCleanup(() => {
            // åœ¨è§†å›¾åˆ·æ–°æ—¶éšè— tooltip
            tooltipManager.hide();
        });
    }
}
```

**æ­¥éª¤3ï¼šåœ¨æ’ä»¶å¸è½½æ—¶æ¸…ç†**

```typescript
// main.ts
unload() {
    // ... å…¶ä»–æ¸…ç†ä»£ç  ...
    TooltipManager.reset(); // æ¸…ç† TooltipManager
}
```

#### 6.1.3 æ€§èƒ½å¯¹æ¯”

```mermaid
graph TB
    subgraph å½“å‰å®ç°["å½“å‰å®ç° (æ¯æ¬¡åˆ›å»º)"]
        A1[mouseenter] --> A2[åˆ›å»º tooltip DOM]
        A2 --> A3[åˆ›å»ºå­å…ƒç´  15+]
        A3 --> A4[å¡«å……å†…å®¹]
        A4 --> A5[getBoundingClientRect]
        A5 --> A6[offsetHeight è¯»å–]
        A6 --> A7[è®¡ç®—å®šä½]
        A7 --> A8[è®¾ç½®æ ·å¼]
        A8 --> A9[CSS transition 200ms]
    end

    subgraph ä¼˜åŒ–å["Tooltipå¤ç”¨ (é¦–æ¬¡åå¤ç”¨)"]
        B1[mouseenter] --> B2{tooltip å­˜åœ¨?}
        B2 -->|é¦–æ¬¡| B3[åˆ›å»º tooltip DOM]
        B2 -->|å¤ç”¨| B4[æ›´æ–°å†…å®¹ innerHTML]
        B3 --> B5[ç¼“å­˜å­å…ƒç´ å¼•ç”¨]
        B4 --> B6[ä¼°ç®—é«˜åº¦ æ— é‡æ’]
        B5 --> B6
        B6 --> B7[æ›´æ–°å®šä½]
        B7 --> B8[æ˜¾ç¤º opacity:1]
    end

    style A1 fill:#ffcdd2
    style A5 fill:#ffcdd2
    style A6 fill:#ffcdd2
    style A9 fill:#ffcdd2
    style B4 fill:#c8e6c9
    style B6 fill:#c8e6c9
    style B8 fill:#c8e6c9
```

#### 6.1.4 é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | å½“å‰å®ç° | Tooltipå¤ç”¨ | æå‡ |
|-----|---------|------------|------|
| é¦–æ¬¡ hover | ~200ms | ~50ms | 75% â†“ |
| åç»­ hover | ~200ms | ~10ms | 95% â†“ |
| DOM æ“ä½œ | 15+ å…ƒç´  | innerHTML æ›´æ–° | 80% â†“ |
| å†…å­˜åˆ†é… | é¢‘ç¹ GC | ç¨³å®š | - |
| FPS | 20-30fps | 55-60fps | 100% â†‘ |

### 6.2 æ–¹æ¡ˆB: å»¶è¿Ÿåˆ›å»º

```typescript
// åªåœ¨é¼ æ ‡åœç•™ä¸€å®šæ—¶é—´åæ‰åˆ›å»ºtooltip
let showTimer: number | null = null;

taskItem.addEventListener('mouseenter', () => {
    showTimer = window.setTimeout(() => {
        this.createTaskTooltip(...);
    }, 300); // 300ms å»¶è¿Ÿ
});

taskItem.addEventListener('mouseleave', () => {
    if (showTimer) {
        clearTimeout(showTimer);
        showTimer = null;
    }
});
```

**ä¼˜ç‚¹**ï¼š
- å¿«é€Ÿæ è¿‡æ—¶ä¸åˆ›å»ºtooltip
- å‡å°‘æ— æ•ˆçš„DOMæ“ä½œ
- å®ç°ç®€å•

### 6.3 æ–¹æ¡ˆC: ç®€åŒ–Tooltipå†…å®¹

```typescript
// å‡å°‘tooltipä¸­çš„å…ƒç´ æ•°é‡
// å½“å‰ï¼šæè¿° + ä¼˜å…ˆçº§ + 6ä¸ªæ—¶é—´å±æ€§ + æ ‡ç­¾ + æ–‡ä»¶ä½ç½®
// ä¼˜åŒ–ï¼šåªæ˜¾ç¤ºæè¿° + æ–‡ä»¶ä½ç½®
```

**ä¼˜ç‚¹**ï¼š
- å‡å°‘DOMå…ƒç´ æ•°é‡
- é™ä½å¸ƒå±€è®¡ç®—å¤æ‚åº¦

### 6.4 æ–¹æ¡ˆD: ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

#### 6.4.1 é—®é¢˜èƒŒæ™¯

åœ¨å‘¨è§†å›¾å’Œæœˆè§†å›¾ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤§é‡ä»»åŠ¡å¡ç‰‡ï¼š

```typescript
// å½“å‰å®ç°ï¼šWeekView.ts
currentDayTasks.forEach(task => this.renderWeekTaskItem(task, columnContainer, targetDate));
// â†‘ å¦‚æœæŸå¤©æœ‰ 50 ä¸ªä»»åŠ¡ï¼Œå°±ä¼šåˆ›å»º 50 ä¸ª DOM å…ƒç´ 
```

**DOM æ•°é‡çˆ†ç‚¸**ï¼š

| è§†å›¾ | å¤©æ•° | æ¯å¤©ä»»åŠ¡æ•° | æ€»DOMå…ƒç´  |
|-----|-----|----------|----------|
| å‘¨è§†å›¾ | 7å¤© | 20ä¸ª | 140ä¸ªä»»åŠ¡å¡ç‰‡ + tooltip äº‹ä»¶ç›‘å¬å™¨ |
| æœˆè§†å›¾ | 35å¤© | 20ä¸ª | 700ä¸ªä»»åŠ¡å¡ç‰‡ + tooltip äº‹ä»¶ç›‘å¬å™¨ |

æ¯ä¸ªä»»åŠ¡å¡ç‰‡éƒ½æœ‰ï¼š
- è‡ªèº«çš„ DOM ç»“æ„
- 2ä¸ªäº‹ä»¶ç›‘å¬å™¨ (mouseenter + mouseleave)
- Tooltip ç›¸å…³çš„é—­åŒ…å¼•ç”¨

**å†…å­˜å ç”¨ä¼°ç®—**ï¼š
```
å•ä¸ªä»»åŠ¡å¡ç‰‡å†…å­˜ â‰ˆ 2KB (DOM + äº‹ä»¶ç›‘å¬å™¨ + é—­åŒ…)
æœˆè§†å›¾ 700 ä¸ªå¡ç‰‡ â‰ˆ 1.4MB
```

#### 6.4.2 è™šæ‹Ÿåˆ—è¡¨åŸç†

```
å¯è§çª—å£
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† è™šæ‹Ÿç©ºé—´ï¼ˆæœªæ¸²æŸ“ï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ä»»åŠ¡ 1ï¼ˆå·²æ¸²æŸ“ï¼‰         â”‚      â”‚
â”‚  â”‚ ä»»åŠ¡ 2ï¼ˆå·²æ¸²æŸ“ï¼‰         â”‚ â† ç¼“å†²åŒº
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ ä»»åŠ¡ 3ï¼ˆå¯è§ä¸­ï¼‰         â”‚ â† å¯è§åŒºåŸŸ
â”‚  â”‚ ä»»åŠ¡ 4ï¼ˆå¯è§ä¸­ï¼‰         â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ ä»»åŠ¡ 5ï¼ˆå·²æ¸²æŸ“ï¼‰         â”‚ â† ç¼“å†²åŒº
â”‚  â”‚ ä»»åŠ¡ 6ï¼ˆå·²æ¸²æŸ“ï¼‰         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                    â”‚
â”‚  â†’ æ»šåŠ¨æ—¶åŠ¨æ€æ›´æ–°æ¸²æŸ“å†…å®¹           â”‚
â”‚                                    â”‚
â”‚  â† è™šæ‹Ÿç©ºé—´ï¼ˆæœªæ¸²æŸ“ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.4.3 å®Œæ•´å®ç°ä»£ç 

**æ­¥éª¤1ï¼šåˆ›å»ºè™šæ‹Ÿåˆ—è¡¨ç®¡ç†å™¨**

```typescript
// src/utils/virtualListManager.ts
import type { GanttTask } from '../types';

interface VirtualListConfig {
    containerHeight: number;      // å®¹å™¨é«˜åº¦
    itemHeight: number;           // å•é¡¹é«˜åº¦
    bufferItems: number;          // ä¸Šä¸‹ç¼“å†²åŒºé¡¹æ•°
    onRenderItem: (task: GanttTask, index: number) => void;  // æ¸²æŸ“å›è°ƒ
}

interface RenderRange {
    startIndex: number;
    endIndex: number;
    offsetY: number;
}

/**
 * è™šæ‹Ÿåˆ—è¡¨ç®¡ç†å™¨
 * åªæ¸²æŸ“å¯è§åŒºåŸŸçš„ä»»åŠ¡å¡ç‰‡ï¼Œå¤§å¹…å‡å°‘ DOM æ•°é‡
 */
export class VirtualListManager {
    private allTasks: GanttTask[] = [];
    private container: HTMLElement | null = null;
    private viewport: HTMLElement | null = null;
    private spacerBefore: HTMLElement | null = null;
    private spacerAfter: HTMLElement | null = null;

    private config: VirtualListConfig;
    private currentRange: RenderRange = { startIndex: 0, endIndex: 0, offsetY: 0 };

    // å·²æ¸²æŸ“çš„ DOM ç¼“å­˜
    private renderedItems = new Map<number, HTMLElement>();
    private scrollTop = 0;

    constructor(config: VirtualListConfig) {
        this.config = {
            bufferItems: config.bufferItems ?? 5,  // é»˜è®¤ä¸Šä¸‹å„ç¼“å†² 5 é¡¹
            ...config
        };
    }

    /**
     * åˆå§‹åŒ–è™šæ‹Ÿåˆ—è¡¨
     */
    init(container: HTMLElement, tasks: GanttTask[]): void {
        this.allTasks = tasks;
        this.container = container;

        // æ¸…ç©ºå®¹å™¨
        container.empty();

        // åˆ›å»ºè§†å£å®¹å™¨
        this.viewport = container.createDiv('virtual-list-viewport');
        this.viewport.style.height = `${this.config.containerHeight}px`;
        this.viewport.style.overflow = 'auto';
        this.viewport.style.position = 'relative';

        // åˆ›å»ºä¸Šä¸‹å ä½ç¬¦ï¼ˆæ’‘å¼€æ»šåŠ¨æ¡ï¼‰
        this.spacerBefore = this.viewport.createDiv('virtual-list-spacer-before');
        this.spacerAfter = this.viewport.createDiv('virtual-list-spacer-after');

        // è®¡ç®—æ€»é«˜åº¦
        const totalHeight = this.allTasks.length * this.config.itemHeight;
        this.spacerBefore.style.height = '0px';
        this.spacerAfter.style.height = `${totalHeight}px`;

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        this.viewport.addEventListener('scroll', this.handleScroll.bind(this));

        // åˆå§‹æ¸²æŸ“
        this.updateRenderRange();
    }

    /**
     * å¤„ç†æ»šåŠ¨äº‹ä»¶
     */
    private handleScroll(): void {
        if (!this.viewport) return;

        const newScrollTop = this.viewport.scrollTop;

        // æ»šåŠ¨ä½ç½®æ²¡å˜åŒ–åˆ™è·³è¿‡
        if (Math.abs(newScrollTop - this.scrollTop) < this.config.itemHeight / 2) {
            return;
        }

        this.scrollTop = newScrollTop;
        this.updateRenderRange();
    }

    /**
     * æ›´æ–°æ¸²æŸ“èŒƒå›´
     */
    private updateRenderRange(): void {
        if (!this.viewport || !this.spacerBefore || !this.spacerAfter) return;

        const viewportHeight = this.config.containerHeight;
        const itemHeight = this.config.itemHeight;
        const bufferHeight = this.config.bufferItems * itemHeight;

        // è®¡ç®—å¯è§èŒƒå›´
        const visibleStart = Math.floor(this.scrollTop / itemHeight);
        const visibleEnd = Math.ceil((this.scrollTop + viewportHeight) / itemHeight);

        // åŠ ä¸Šç¼“å†²åŒº
        const startIndex = Math.max(0, visibleStart - this.config.bufferItems);
        const endIndex = Math.min(this.allTasks.length, visibleEnd + this.config.bufferItems);

        // æ›´æ–°å ä½ç¬¦é«˜åº¦
        this.spacerBefore.style.height = `${startIndex * itemHeight}px`;
        this.spacerAfter.style.height = `${(this.allTasks.length - endIndex) * itemHeight}px`;

        // æ¸²æŸ“å¯è§é¡¹
        this.renderItems(startIndex, endIndex);

        this.currentRange = { startIndex, endIndex, offsetY: startIndex * itemHeight };
    }

    /**
     * æ¸²æŸ“æŒ‡å®šèŒƒå›´å†…çš„é¡¹ç›®
     */
    private renderItems(startIndex: number, endIndex: number): void {
        if (!this.viewport) return;

        // ç§»é™¤ä¸å†å¯è§çš„é¡¹ç›®
        const toRemove: number[] = [];
        for (const [index, element] of this.renderedItems) {
            if (index < startIndex || index >= endIndex) {
                element.remove();
                toRemove.push(index);
            }
        }
        toRemove.forEach(index => this.renderedItems.delete(index));

        // æ¸²æŸ“æ–°å¯è§çš„é¡¹ç›®
        for (let i = startIndex; i < endIndex; i++) {
            if (!this.renderedItems.has(i)) {
                const task = this.allTasks[i];
                const itemElement = this.viewport.createDiv('virtual-list-item');
                itemElement.style.position = 'absolute';
                itemElement.style.top = `${(i - startIndex) * this.config.itemHeight}px`;
                itemElement.style.height = `${this.config.itemHeight}px`;
                itemElement.style.width = '100%';

                // è°ƒç”¨æ¸²æŸ“å›è°ƒ
                this.config.onRenderItem(task, i);

                this.renderedItems.set(i, itemElement);
            }
        }
    }

    /**
     * æ›´æ–°ä»»åŠ¡åˆ—è¡¨
     */
    updateTasks(tasks: GanttTask[]): void {
        this.allTasks = tasks;

        if (this.spacerAfter) {
            const totalHeight = this.allTasks.length * this.config.itemHeight;
            this.spacerAfter.style.height = `${totalHeight}px`;
        }

        // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“
        this.renderedItems.forEach(el => el.remove());
        this.renderedItems.clear();
        this.updateRenderRange();
    }

    /**
     * é”€æ¯è™šæ‹Ÿåˆ—è¡¨
     */
    destroy(): void {
        if (this.viewport) {
            this.viewport.removeEventListener('scroll', this.handleScroll.bind(this));
        }
        this.renderedItems.forEach(el => el.remove());
        this.renderedItems.clear();
        this.allTasks = [];
        this.container = null;
        this.viewport = null;
        this.spacerBefore = null;
        this.spacerAfter = null;
    }

    /**
     * è·å–å½“å‰æ¸²æŸ“èŒƒå›´
     */
    getRenderRange(): RenderRange {
        return this.currentRange;
    }

    /**
     * æ»šåŠ¨åˆ°æŒ‡å®šç´¢å¼•
     */
    scrollToIndex(index: number): void {
        if (!this.viewport || index < 0 || index >= this.allTasks.length) return;

        const targetScrollTop = index * this.config.itemHeight;
        this.viewport.scrollTop = targetScrollTop;
    }
}
```

**æ­¥éª¤2ï¼šä¿®æ”¹å‘¨è§†å›¾ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨**

```typescript
// src/views/WeekView.ts
import { VirtualListManager } from '../utils/virtualListManager';

export class WeekViewRenderer extends BaseCalendarRenderer {
    // å­˜å‚¨æ¯å¤©çš„è™šæ‹Ÿåˆ—è¡¨å®ä¾‹
    private virtualLists = new Map<HTMLElement, VirtualListManager>();

    render(container: HTMLElement, currentDate: Date): void {
        // ... ç°æœ‰çš„å‘¨è§†å›¾ä»£ç  ...

        // æ¸…ç†æ—§çš„è™šæ‹Ÿåˆ—è¡¨
        this.virtualLists.forEach(vl => vl.destroy());
        this.virtualLists.clear();

        // ä»»åŠ¡ç½‘æ ¼ - ä¸ƒåˆ—
        const tasksGrid = weekGrid.createDiv('calendar-week-tasks-grid');
        weekData.days.forEach((day) => {
            const dayTasksColumn = tasksGrid.createDiv('calendar-week-tasks-column');
            if (day.isToday) {
                dayTasksColumn.addClass('today');
            }

            // ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨åŠ è½½ä»»åŠ¡
            this.loadWeekViewTasksWithVirtualList(dayTasksColumn, day.date);

            // è®¾ç½®æ‹–æ‹½ç›®æ ‡
            this.setupDragDropForColumn(dayTasksColumn, day.date);
        });

        // æ³¨å†Œæ¸…ç†
        this.registerDomCleanup(() => {
            this.virtualLists.forEach(vl => vl.destroy());
            this.virtualLists.clear();
        });
    }

    /**
     * ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨åŠ è½½å‘¨è§†å›¾ä»»åŠ¡
     */
    private loadWeekViewTasksWithVirtualList(columnContainer: HTMLElement, targetDate: Date): void {
        try {
            let tasks: GanttTask[] = this.plugin.taskCache.getAllTasks();
            tasks = this.applyTagFilter(tasks);
            const dateField = this.plugin.settings.dateFilterField || 'dueDate';

            const normalizedTarget = new Date(targetDate);
            normalizedTarget.setHours(0, 0, 0, 0);

            // ç­›é€‰å½“å¤©ä»»åŠ¡
            let currentDayTasks = tasks.filter(task => {
                const dateValue = (task as any)[dateField];
                if (!dateValue) return false;

                const taskDate = new Date(dateValue);
                if (isNaN(taskDate.getTime())) return false;
                taskDate.setHours(0, 0, 0, 0);

                return taskDate.getTime() === normalizedTarget.getTime();
            });

            // åº”ç”¨æ’åº
            currentDayTasks = sortTasks(currentDayTasks, this.sortState);

            if (currentDayTasks.length === 0) {
                columnContainer.createEl('div', { text: 'æš‚æ— ä»»åŠ¡', cls: 'calendar-week-task-empty' });
                return;
            }

            // è·å–å®¹å™¨é«˜åº¦ï¼ˆä» CSS æˆ–é»˜è®¤å€¼ï¼‰
            const containerHeight = 600; // æˆ–ä» CSS è¯»å–
            const itemHeight = 40; // å•ä¸ªä»»åŠ¡å¡ç‰‡é«˜åº¦

            // åˆ›å»ºè™šæ‹Ÿåˆ—è¡¨
            const virtualList = new VirtualListManager({
                containerHeight,
                itemHeight,
                bufferItems: 5,
                onRenderItem: (task, index) => {
                    // å¤ç”¨ç°æœ‰çš„ä»»åŠ¡æ¸²æŸ“é€»è¾‘
                    // éœ€è¦å°† renderWeekTaskItem æ”¹é€ ä¸ºä¸ä¾èµ– container å‚æ•°
                    this.renderWeekTaskItem(task, columnContainer, targetDate);
                }
            });

            virtualList.init(columnContainer, currentDayTasks);
            this.virtualLists.set(columnContainer, virtualList);

        } catch (error) {
            console.error('Error loading week view tasks with virtual list', error);
            columnContainer.createEl('div', { text: 'åŠ è½½å‡ºé”™', cls: 'calendar-week-task-empty' });
        }
    }
}
```

**æ­¥éª¤3ï¼šé…å¥—çš„ CSS æ ·å¼**

```css
/* src/styles/virtual-list.css */

.virtual-list-viewport {
    position: relative;
    overflow-y: auto;
    overflow-x: hidden;
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-thumb-bg) var(--scrollbar-bg);
}

.virtual-list-viewport::-webkit-scrollbar {
    width: 8px;
}

.virtual-list-viewport::-webkit-scrollbar-track {
    background: var(--scrollbar-bg);
}

.virtual-list-viewport::-webkit-scrollbar-thumb {
    background-color: var(--scrollbar-thumb-bg);
    border-radius: 4px;
}

.virtual-list-spacer-before,
.virtual-list-spacer-after {
    width: 100%;
    pointer-events: none;
}

.virtual-list-item {
    box-sizing: border-box;
    /* ç¡®ä¿é¡¹ç›®é«˜åº¦å›ºå®š */
    min-height: 40px;
    max-height: 40px;
}
```

#### 6.4.4 è™šæ‹Ÿåˆ—è¡¨æ¶æ„å›¾

```mermaid
graph TB
    subgraph æ•°æ®å±‚["æ•°æ®å±‚"]
        A1[å…¨éƒ¨ä»»åŠ¡æ•°æ®<br/>GanttTask[]]
    end

    subgraph é€»è¾‘å±‚["VirtualListManager"]
        B1[è®¡ç®—å¯è§èŒƒå›´]
        B2[ç®¡ç†æ¸²æŸ“çŠ¶æ€]
        B3[å¤„ç†æ»šåŠ¨äº‹ä»¶]
    end

    subgraph è§†å›¾å±‚["DOMå±‚"]
        C1[Spacer Before<br/>å ä½ä¸Šæ–¹çš„æœªæ¸²æŸ“é¡¹]
        C2[Viewport<br/>å¯æ»šåŠ¨å®¹å™¨]
        C3[Buffer Items<br/>ä¸Šç¼“å†²åŒº 5é¡¹]
        C4[Visible Items<br/>å¯è§åŒºåŸŸé¡¹ç›®]
        C5[Buffer Items<br/>ä¸‹ç¼“å†²åŒº 5é¡¹]
        C6[Spacer After<br/>å ä½ä¸‹æ–¹çš„æœªæ¸²æŸ“é¡¹]
    end

    A1 --> B1
    B1 --> B2
    B3 --> B1

    B2 --> C1
    B2 --> C6
    B2 --> C3
    B2 --> C4
    B2 --> C5

    C3 --> C2
    C4 --> C2
    C5 --> C2

    style A1 fill:#e3f2fd
    style B1 fill:#fff3e0
    style B2 fill:#fff3e0
    style B3 fill:#fff3e0
    style C4 fill:#c8e6c9
```

#### 6.4.5 æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | å½“å‰å®ç° | è™šæ‹Ÿåˆ—è¡¨ | æå‡ |
|-----|---------|---------|------|
| æœˆè§†å›¾ 700 ä»»åŠ¡ | 700 ä¸ª DOM | ~30 ä¸ª DOM | 96% â†“ |
| åˆå§‹æ¸²æŸ“æ—¶é—´ | ~500ms | ~50ms | 90% â†“ |
| å†…å­˜å ç”¨ | ~1.4MB | ~60KB | 96% â†“ |
| äº‹ä»¶ç›‘å¬å™¨ | 1400 ä¸ª | 60 ä¸ª | 96% â†“ |
| æ»šåŠ¨ FPS | 10-20fps | 55-60fps | 200% â†‘ |

#### 6.4.6 ä½¿ç”¨åœºæ™¯å»ºè®®

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | åŸå›  |
|-----|---------|------|
| ä»»åŠ¡æ•° < 20 | ä¸éœ€è¦è™šæ‹Ÿåˆ—è¡¨ | å¼€é”€å¤§äºæ”¶ç›Š |
| ä»»åŠ¡æ•° 20-50 | å¯é€‰ | è§†è®¾å¤‡æ€§èƒ½å†³å®š |
| ä»»åŠ¡æ•° > 50 | å¼ºçƒˆæ¨èè™šæ‹Ÿåˆ—è¡¨ | æ€§èƒ½æå‡æ˜æ˜¾ |
| ç§»åŠ¨ç«¯è®¾å¤‡ | æ¨èè™šæ‹Ÿåˆ—è¡¨ | å†…å­˜å—é™ |

#### 6.4.7 æ³¨æ„äº‹é¡¹

1. **å›ºå®šé«˜åº¦è¦æ±‚**ï¼šè™šæ‹Ÿåˆ—è¡¨è¦æ±‚æ¯ä¸ªä»»åŠ¡å¡ç‰‡é«˜åº¦å›ºå®šæˆ–å¯é¢„æµ‹
2. **åŠ¨æ€é«˜åº¦é€‚é…**ï¼šå¦‚æœä»»åŠ¡å¡ç‰‡é«˜åº¦ä¸å›ºå®šï¼Œéœ€è¦åŠ¨æ€è®¡ç®—é«˜åº¦
3. **æ»šåŠ¨åŒæ­¥**ï¼šè™šæ‹Ÿæ»šåŠ¨ä¸åŸç”Ÿæ»šåŠ¨è¡Œä¸ºç•¥æœ‰å·®å¼‚
4. **å¤æ‚åº¦å¢åŠ **ï¼šä»£ç å¤æ‚åº¦å¢åŠ ï¼Œéœ€è¦å……åˆ†æµ‹è¯•

---

## 7. CSSå±‚é¢ä¼˜åŒ–

### 7.1 ä½¿ç”¨ will-change æç¤º

```css
.gc-task-card {
    will-change: transform;
}

.gc-task-tooltip {
    will-change: opacity, transform;
}
```

### 7.2 å‡å°‘transitionæ—¶é—´

```css
/* ä» 200ms å‡å°‘åˆ° 100ms */
transition: opacity 0.1s ease,
            transform 0.1s ease;
```

### 7.3 ä½¿ç”¨ GPU åŠ é€Ÿ

```css
.gc-task-tooltip {
    transform: translateZ(0); /* å¼ºåˆ¶GPUåˆæˆ */
}
```

---

## 8. éªŒè¯æ–¹æ³•

### 8.1 æ€§èƒ½æµ‹è¯•

ä½¿ç”¨ Chrome DevTools:

1. æ‰“å¼€ Performance é¢æ¿
2. å¼€å§‹å½•åˆ¶
3. åœ¨å‘¨è§†å›¾ä¸­å¿«é€Ÿæ»‘è¿‡å¤šä¸ªä»»åŠ¡å¡ç‰‡
4. åœæ­¢å½•åˆ¶å¹¶åˆ†æ

**å…³æ³¨æŒ‡æ ‡**ï¼š
- FPS (åº”è¯¥ä¿æŒ 60fps)
- Long Tasks (>50ms)
- Layout Thrashing (å¸ƒå±€æŠ–åŠ¨)

### 8.2 å¯¹æ¯”æµ‹è¯•

| æµ‹è¯•åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|---------|-------|-------|
| å•æ¬¡hoverå»¶è¿Ÿ | ~200ms | ~50ms |
| å¿«é€Ÿæ»‘è¿‡10ä¸ªå¡ç‰‡ | å¡é¡¿æ˜æ˜¾ | æµç•… |
| FPS | 20-30fps | 55-60fps |

---

## 9. ç»“è®ºä¸ä¼˜åŒ–è·¯çº¿å›¾

### 9.1 é—®é¢˜ç¡®è®¤

**ç”¨æˆ·çš„æ¨æµ‹å®Œå…¨æ­£ç¡®**ï¼šä»»åŠ¡å¡ç‰‡çš„æ‚¬æµ®å¡é¡¿é—®é¢˜ç¡®å®æ˜¯ç”± `createTaskTooltip` é€ æˆçš„ã€‚

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. æ¯æ¬¡é¼ æ ‡æ‚¬åœéƒ½åˆ›å»ºæ–°çš„å®Œæ•´ DOM ç»“æ„
2. å¼ºåˆ¶åŒæ­¥å¸ƒå±€è®¡ç®—å¯¼è‡´ä¸»çº¿ç¨‹é˜»å¡
3. CSS transition ä¸å¿«é€Ÿ hover å†²çª

### 9.2 ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®ç°éš¾åº¦ | æ€§èƒ½æå‡ | å…¼å®¹æ€§é£é™© | æ¨èä¼˜å…ˆçº§ |
|-----|---------|---------|-----------|-----------|
| **æ–¹æ¡ˆA: Tooltipå¤ç”¨** | ä¸­ | é«˜ (95% â†“) | ä½ | ğŸ”´ P0 ç«‹å³å®æ–½ |
| **æ–¹æ¡ˆB: å»¶è¿Ÿåˆ›å»º** | ä½ | ä¸­ (60% â†“) | æ—  | ğŸŸ¡ P1 å¿«é€Ÿä¿®å¤ |
| **æ–¹æ¡ˆC: ç®€åŒ–å†…å®¹** | ä½ | ä½ (30% â†“) | æ—  | ğŸŸ¢ P2 å¯é€‰ |
| **æ–¹æ¡ˆD: è™šæ‹Ÿåˆ—è¡¨** | é«˜ | æé«˜ (96% â†“) | é«˜ | ğŸŸ¢ P3 é•¿æœŸè§„åˆ’ |

### 9.3 å®æ–½è·¯çº¿å›¾

```mermaid
gantt
    title ä¼˜åŒ–æ–¹æ¡ˆå®æ–½æ—¶é—´çº¿
    dateFormat  YYYY-MM-DD
    section Phase 1 (ç´§æ€¥ä¿®å¤)
    æ–¹æ¡ˆB: å»¶è¿Ÿåˆ›å»º      :p1, 2024-01-01, 2d
    section Phase 2 (æ ¸å¿ƒä¼˜åŒ–)
    æ–¹æ¡ˆA: Tooltipå¤ç”¨   :p2, after p1, 5d
    section Phase 3 (å¢å¼ºä½“éªŒ)
    æ–¹æ¡ˆC: ç®€åŒ–å†…å®¹      :p3, after p2, 2d
    section Phase 4 (é•¿æœŸé‡æ„)
    æ–¹æ¡ˆD: è™šæ‹Ÿåˆ—è¡¨      :p4, 2024-02-01, 10d
```

#### Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šå¿«é€Ÿæ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œä½œä¸ºä¸´æ—¶æ–¹æ¡ˆ

```typescript
// åœ¨ BaseCalendarRenderer.ts ä¸­æ·»åŠ å»¶è¿Ÿ
protected createTaskTooltip(task: GanttTask, taskItem: HTMLElement, cleaned: string): void {
    let showTimer: number | null = null;
    const SHOW_DELAY = 300; // 300ms å»¶è¿Ÿ

    taskItem.addEventListener('mouseenter', () => {
        showTimer = window.setTimeout(() => {
            // åŸæœ‰çš„ tooltip åˆ›å»ºé€»è¾‘
            this.showTooltipInternal(task, taskItem, cleaned);
        }, SHOW_DELAY);
    });

    taskItem.addEventListener('mouseleave', () => {
        if (showTimer) {
            clearTimeout(showTimer);
            showTimer = null;
        }
        this.hideTooltip();
    });
}
```

**é¢„æœŸæ•ˆæœ**ï¼šå¿«é€Ÿæ è¿‡æ—¶ä¸åˆ›å»º tooltipï¼Œå‡å°‘ 60% çš„æ— æ•ˆæ“ä½œ

#### Phase 2: æ ¸å¿ƒä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰

**ç›®æ ‡**ï¼šå½»åº•è§£å†³æ€§èƒ½é—®é¢˜ï¼Œå®ç° Tooltip å¤ç”¨

- åˆ›å»º `TooltipManager` å•ä¾‹ç±»ï¼ˆè¯¦è§ 6.1.2ï¼‰
- ä¿®æ”¹ `BaseCalendarRenderer.createTaskTooltip` æ–¹æ³•
- æ›´æ–°æ’ä»¶å¸è½½é€»è¾‘

**é¢„æœŸæ•ˆæœ**ï¼šåç»­ hover å»¶è¿Ÿé™ä½ 95%ï¼ŒFPS æå‡è‡³ 55-60

#### Phase 3: å¢å¼ºä½“éªŒï¼ˆ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šè¿›ä¸€æ­¥ä¼˜åŒ– tooltip æ˜¾ç¤ºæ€§èƒ½

- è¯„ä¼°æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ‰€æœ‰æ—¶é—´å±æ€§
- è€ƒè™‘æ·»åŠ ç”¨æˆ·é…ç½®é€‰é¡¹
- ä¼˜åŒ– CSS transition æ—¶é—´

**é¢„æœŸæ•ˆæœ**ï¼štooltip æ¸²æŸ“æ—¶é—´å†é™ä½ 30%

#### Phase 4: é•¿æœŸé‡æ„ï¼ˆå¯é€‰ï¼Œ1-2å‘¨ï¼‰

**ç›®æ ‡**ï¼šè§£å†³å¤§é‡ä»»åŠ¡çš„ DOM çˆ†ç‚¸é—®é¢˜

- å®ç°è™šæ‹Ÿåˆ—è¡¨ç®¡ç†å™¨ï¼ˆè¯¦è§ 6.4.3ï¼‰
- é€‚é…å‘¨è§†å›¾å’Œæœˆè§†å›¾
- å¤„ç†åŠ¨æ€é«˜åº¦åœºæ™¯

**é¢„æœŸæ•ˆæœ**ï¼šæœˆè§†å›¾ 700 ä»»åŠ¡æ—¶ DOM æ•°é‡å‡å°‘ 96%

### 9.4 æœ€ç»ˆå»ºè®®

**ç«‹å³è¡ŒåŠ¨**ï¼š
1. å…ˆå®æ–½ **æ–¹æ¡ˆBï¼ˆå»¶è¿Ÿåˆ›å»ºï¼‰** ä½œä¸ºå¿«é€Ÿä¿®å¤
2. ç´§æ¥ç€å®æ–½ **æ–¹æ¡ˆAï¼ˆTooltipå¤ç”¨ï¼‰** ä½œä¸ºæ ¹æœ¬è§£å†³æ–¹æ¡ˆ

**ç»„åˆæ•ˆæœ**ï¼š
- æ–¹æ¡ˆA + æ–¹æ¡ˆB ç»„åˆä½¿ç”¨ï¼Œå»¶è¿Ÿ + å¤ç”¨ = æœ€ä½³ä½“éªŒ
- é¢„æœŸæ•´ä½“æ€§èƒ½æå‡ï¼š**98%**

**è¯„ä¼°æ ‡å‡†**ï¼š
- é¼ æ ‡å¿«é€Ÿæ»‘è¿‡ 10 ä¸ªä»»åŠ¡å¡ç‰‡ï¼ŒFPS ä¿æŒåœ¨ 55+
- å•æ¬¡ hover å“åº”å»¶è¿Ÿ < 50ms
- å†…å­˜å ç”¨ç¨³å®šï¼Œæ— æ˜æ˜¾å¢é•¿

---

## 10. é™„å½•

### 10.1 ç›¸å…³æ–‡ä»¶ï¼ˆæœ€æ–°æ¶æ„ï¼‰

| æ–‡ä»¶ | ä½œç”¨ | å…³é”®å†…å®¹ |
|-----|------|---------|
| `src/components/TaskCard/TaskCardRenderer.ts:343-458` | attachTooltip æ–¹æ³•å®ç° | âš ï¸ æ€§èƒ½ç“¶é¢ˆæºå¤´ |
| `src/components/TaskCard/presets/WeekView.config.ts:24` | å‘¨è§†å›¾é…ç½® | `enableTooltip: true` |
| `src/components/TaskCard/presets/MonthView.config.ts:24` | æœˆè§†å›¾é…ç½® | `enableTooltip: true` |
| `src/components/TaskCard/presets/TaskView.config.ts:33` | ä»»åŠ¡è§†å›¾é…ç½® | `enableTooltip: false` âœ… |
| `src/components/TaskCard/presets/DayView.config.ts:24` | æ—¥è§†å›¾é…ç½® | `enableTooltip: false` âœ… |
| `src/components/TaskCard/presets/GanttView.config.ts:24` | ç”˜ç‰¹å›¾é…ç½® | `enableTooltip: false` âœ… |
| `src/views/WeekView.ts:162-178` | å‘¨è§†å›¾ç»„ä»¶è°ƒç”¨ | ä½¿ç”¨ `WeekViewConfig` |
| `src/views/MonthView.ts` | æœˆè§†å›¾ç»„ä»¶è°ƒç”¨ | ä½¿ç”¨ `MonthViewConfig` |
| `styles.css:1256-1363` | Tooltip CSS æ ·å¼ | transition åŠ¨ç”»é…ç½® |

### 10.2 å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

**æœ€ç®€å•çš„ä¿®å¤**ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç¦ç”¨ tooltip

```typescript
// src/components/TaskCard/presets/WeekView.config.ts
export const WeekViewConfig: TaskCardConfig = {
    // ...
    enableTooltip: false,  // â† æ”¹ä¸º falseï¼Œç«‹å³è§£å†³å¡é¡¿
    // ...
};

// src/components/TaskCard/presets/MonthView.config.ts
export const MonthViewConfig: TaskCardConfig = {
    // ...
    enableTooltip: false,  // â† æ”¹ä¸º falseï¼Œç«‹å³è§£å†³å¡é¡¿
    // ...
};
```

**ä¼˜ç‚¹**ï¼š
- ä¸€è¡Œä»£ç ä¿®æ”¹
- ç«‹å³ç”Ÿæ•ˆ
- é›¶é£é™©

**ç¼ºç‚¹**ï¼š
- å¤±å» tooltip åŠŸèƒ½

### 10.3 ä»£ç è¡Œæ•°ç»Ÿè®¡

| ç»„ä»¶/æ–¹æ³• | è¡Œæ•° | ä½œç”¨ |
|---------|-----|------|
| `TaskCardRenderer.attachTooltip` | ~115 è¡Œ | Tooltip åˆ›å»ºå’Œæ˜¾ç¤ºé€»è¾‘ |
| `TaskCardComponent` | ~170 è¡Œ | ä¸»ç»„ä»¶ |
| `TaskCardRenderer` | ~505 è¡Œ | æ¸²æŸ“å™¨å…¨éƒ¨æ–¹æ³• |
| ç›¸å…³ CSS æ ·å¼ | ~108 è¡Œ | Tooltip æ ·å¼ |

### 10.4 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|-----|------|
| Forced Reflow | å¼ºåˆ¶æµè§ˆå™¨é‡æ–°è®¡ç®—é¡µé¢å¸ƒå±€çš„æ“ä½œ |
| Layout Thrashing | åœ¨ JavaScript ä¸­é¢‘ç¹è¯»å–å’Œå†™å…¥å¸ƒå±€å±æ€§å¯¼è‡´æ€§èƒ½ä¸‹é™ |
| CSS Transition | CSS è¿‡æ¸¡åŠ¨ç”»ï¼Œéœ€è¦æ—¶é—´å®Œæˆ |
| mouseenter/mouseleave | DOM äº‹ä»¶ï¼Œé¼ æ ‡è¿›å…¥/ç¦»å¼€å…ƒç´ æ—¶è§¦å‘ |
| getBoundingClientRect | è·å–å…ƒç´ ä½ç½®ä¿¡æ¯ï¼Œä¼šè§¦å‘é‡æ’ |
| TaskCardComponent | ç»Ÿä¸€ä»»åŠ¡å¡ç‰‡ç»„ä»¶ |
| TaskCardRenderer | ä»»åŠ¡å¡ç‰‡æ¸²æŸ“å™¨ |
| View Preset | è§†å›¾é¢„è®¾é…ç½® |
| enableTooltip | é…ç½®é¡¹ï¼Œæ§åˆ¶æ˜¯å¦å¯ç”¨æ‚¬æµ®æç¤º |
