# 任务右键菜单功能实现说明

## 功能概述

为所有视图（日视图、周视图、月视图、任务视图）的任务卡片添加了右键菜单功能，提供以下操作：

### 右键菜单选项

1. **设置开始日期** - 为任务设置或更新开始日期（startDate）
2. **设置截止日期** - 为任务设置或更新截止日期（dueDate）
3. **设置计划日期** - 为任务设置或更新计划日期（scheduledDate）
4. **设置完成日期** - 为任务设置或更新完成日期（completionDate）
5. **取消任务** - 设置任务的取消日期（cancelledDate）为今天
6. **创建任务同名笔记** - 以任务描述为文件名，创建对应的笔记文件

## 文件结构

### 新增文件

```
src/contextMenu/
├── index.ts                              # 右键菜单注册入口
└── commands/
    ├── setStartDate.ts                  # 设置开始日期
    ├── setDueDate.ts                    # 设置截止日期
    ├── setScheduledDate.ts              # 设置计划日期
    ├── setCompletionDate.ts             # 设置完成日期
    ├── cancelTask.ts                    # 取消任务
    └── createNoteFromTask.ts            # 创建任务同名文件
```

### 修改的文件

1. **src/settings.ts**
   - 添加了 `taskNotePath` 设置项（默认路径：'Tasks'）
   - 在设置界面添加了"任务笔记文件夹路径"配置选项

2. **src/views/TaskView.ts**
   - 导入右键菜单模块
   - 在 `renderTaskItem` 方法中注册右键菜单

3. **src/views/DayView.ts**
   - 在 `renderDayTaskItem` 方法中注册右键菜单

4. **src/views/WeekView.ts**
   - 在 `renderWeekTaskItem` 方法中注册右键菜单

5. **src/views/MonthView.ts**
   - 在 `renderMonthTaskItem` 方法中注册右键菜单

6. **styles.css**
   - 添加了日期选择器模态框的样式定义

## 使用说明

### 设置任务笔记路径

1. 打开插件设置
2. 在"任务视图设置"部分找到"任务笔记文件夹路径"
3. 输入自定义路径（相对于库根目录），默认为 'Tasks'

### 使用右键菜单

1. 在任何视图中，右键点击任务卡片
2. 从菜单中选择需要的操作：
   - 选择日期设置选项时，会弹出日期选择器
   - 选择"创建任务同名笔记"会立即创建笔记并打开

### 日期选择器

- 日期选择器使用原生的 HTML5 日期输入控件
- 会显示任务当前的日期值（如果已设置）
- 支持手动输入或使用日历选择器选择日期
- 点击"确定"保存，点击"取消"放弃修改

### 创建任务同名笔记

- 笔记名称会清理所有任务格式标记（emoji、字段标记等）
- 文件名中的非法字符会被替换为连字符
- 笔记内容包含：
  - 任务描述作为标题
  - 任务信息（优先级、各种日期）
  - 来源文件链接
  - 空白笔记内容区域
- 如果文件已存在，会打开已存在的文件而不是覆盖

## 技术实现

### 模块化设计

- 每个右键菜单命令都是独立的模块
- 日期选择器被封装在各个命令模块中
- 主注册函数 `registerTaskContextMenu` 统一管理所有菜单项

### 格式兼容

- 自动检测任务的格式（Tasks 或 Dataview）
- 根据任务原有格式写入日期
- 支持设置中配置的格式偏好

### 刷新机制

- 每个视图的右键菜单回调包含刷新逻辑
- 修改任务后自动刷新当前视图
- 保持用户当前的视图状态

## 注意事项

1. 日期更新会直接修改源文件
2. 创建的笔记存放在设置中指定的文件夹
3. 如果文件夹不存在，会自动创建
4. 取消任务会立即设置取消日期为今天，无需确认

## 图标说明

菜单项使用的图标：
- 🗓️ `calendar-plus` - 设置开始日期
- ✓ `calendar-check` - 设置截止日期
- ⏰ `calendar-clock` - 设置计划日期
- ✅ `check-circle` - 设置完成日期
- ❌ `x-circle` - 取消任务
- 📝 `file-plus` - 创建任务同名笔记
